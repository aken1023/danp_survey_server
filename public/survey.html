<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡å ±èˆå¼Šé¢¨éšªæŒ‡æ¨™å°ˆå®¶å•å· - Fuzzy DANP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .btn-option { transition: all 0.2s ease; }
        .btn-option:hover { transform: translateY(-2px); }
        .btn-option.selected { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .progress-ring { transition: stroke-dashoffset 0.5s ease; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        @media (max-width: 640px) {
            .mobile-stack { flex-direction: column; }
            .mobile-full { width: 100%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-sky-50 min-h-screen">
    <div id="app">
        <!-- è¼‰å…¥ç•«é¢ -->
        <div v-if="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-slate-600">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div v-else class="max-w-4xl mx-auto px-4 py-6 sm:py-8">
            
            <!-- é ‚éƒ¨é€²åº¦å€ -->
            <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-6 sticky top-2 z-40">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3 sm:gap-4">
                        <div class="relative w-14 h-14 sm:w-16 sm:h-16">
                            <svg class="w-14 h-14 sm:w-16 sm:h-16 transform -rotate-90">
                                <circle cx="50%" cy="50%" r="24" stroke="#e2e8f0" stroke-width="5" fill="none"/>
                                <circle cx="50%" cy="50%" r="24" stroke="#0284c7" stroke-width="5" fill="none"
                                    :stroke-dasharray="150" 
                                    :stroke-dashoffset="150 - (150 * overallProgress / 100)"
                                    class="progress-ring"/>
                            </svg>
                            <span class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-bold text-sky-600">
                                {{ Math.round(overallProgress) }}%
                            </span>
                        </div>
                        <div>
                            <h2 class="font-bold text-slate-800 text-sm sm:text-base">{{ stages[currentStage].title }}</h2>
                            <p class="text-xs sm:text-sm text-slate-500">{{ stages[currentStage].subtitle }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs sm:text-sm text-slate-500">é ä¼°å‰©é¤˜</p>
                        <p class="text-base sm:text-lg font-bold text-sky-600">{{ estimatedTime }} åˆ†é˜</p>
                    </div>
                </div>
                
                <!-- éšæ®µæŒ‡ç¤ºå™¨ - æ‰‹æ©Ÿç‰ˆç°¡åŒ– -->
                <div class="hidden sm:flex items-center justify-between">
                    <template v-for="(stage, index) in stages" :key="index">
                        <div class="flex items-center">
                            <div :class="[
                                'w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all',
                                index < currentStage ? 'bg-green-500 text-white' :
                                index === currentStage ? 'bg-sky-600 text-white ring-4 ring-sky-200' :
                                'bg-slate-200 text-slate-500'
                            ]">
                                <span v-if="index < currentStage">âœ“</span>
                                <span v-else>{{ index + 1 }}</span>
                            </div>
                            <span class="ml-2 text-xs hidden lg:inline" :class="index === currentStage ? 'text-sky-600 font-medium' : 'text-slate-400'">
                                {{ stage.short }}
                            </span>
                        </div>
                        <div v-if="index < stages.length - 1" class="flex-1 h-1 mx-2 rounded" :class="index < currentStage ? 'bg-green-500' : 'bg-slate-200'"></div>
                    </template>
                </div>
                <!-- æ‰‹æ©Ÿç‰ˆé€²åº¦æ¢ -->
                <div class="sm:hidden">
                    <div class="flex justify-between text-xs text-slate-500 mb-1">
                        <span>éšæ®µ {{ currentStage + 1 }} / {{ stages.length }}</span>
                        <span>{{ stages[currentStage].short }}</span>
                    </div>
                    <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-sky-500 transition-all" :style="{width: ((currentStage + 1) / stages.length * 100) + '%'}"></div>
                    </div>
                </div>
            </div>

            <!-- ==================== Stage 0: æ­¡è¿é  ==================== -->
            <transition name="fade" mode="out-in">
                <div v-if="currentStage === 0" key="welcome" class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-sky-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-800 mb-2">è²¡å ±èˆå¼Šé¢¨éšªè©•ä¼°æŒ‡æ¨™</h1>
                        <h2 class="text-lg sm:text-xl text-sky-600 mb-4">å°ˆå®¶å•å·èª¿æŸ¥</h2>
                        <p class="text-slate-600 max-w-lg mx-auto text-sm sm:text-base">
                            æ„Ÿè¬æ‚¨æ’¥å†—åƒèˆ‡æœ¬ç ”ç©¶ã€‚æœ¬å•å·æ—¨åœ¨è’é›†å°ˆå®¶æ„è¦‹ï¼Œå»ºç«‹è²¡å ±èˆå¼Šé¢¨éšªè©•ä¼°æŒ‡æ¨™çš„æ¬Šé‡é«”ç³»ã€‚
                        </p>
                    </div>

                    <!-- ğŸ”’ éš±ç§è²æ˜ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 sm:p-5 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-blue-800 mb-1">ğŸ”’ è³‡æ–™ä½¿ç”¨è²æ˜</h4>
                                <p class="text-sm text-blue-700">
                                    æœ¬å•å·<strong>åƒ…ä¾›ç ”ç©¶ä¹‹ç³»çµ±å»ºæ§‹ä½¿ç”¨</strong>ï¼Œæ‰€è’é›†ä¹‹è³‡æ–™å°‡ä»¥åŒ¿åæ–¹å¼é€²è¡Œçµ±è¨ˆåˆ†æï¼Œ
                                    <strong>ä¸æœƒæ­éœ²ä»»ä½•å¯è­˜åˆ¥å€‹äººèº«åˆ†ä¹‹è³‡è¨Š</strong>ã€‚æ‚¨çš„å›ç­”å°‡ç”¨æ–¼è¨ˆç®—è²¡å ±èˆå¼Šé¢¨éšªæŒ‡æ¨™çš„æ¬Šé‡ï¼Œ
                                    ç ”ç©¶æˆæœå°‡ä»¥å½™ç¸½å½¢å¼å‘ˆç¾ã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- â° æ™‚é–“èªªæ˜ -->
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 sm:p-5 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-xl">â°</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-amber-800 mb-1">å¡«ç­”æ™‚é–“èªªæ˜</h4>
                                <p class="text-sm text-amber-700">
                                    æœ¬å•å·æ¡ç”¨å®Œæ•´çš„ <strong>Fuzzy DANP æ–¹æ³•</strong>ï¼ŒåŒ…å«å½±éŸ¿é—œä¿‚è©•ä¼°èˆ‡é‡è¦æ€§æ¯”è¼ƒå…©å¤§éƒ¨åˆ†ï¼Œ
                                    é ä¼°éœ€è¦ <strong>40-50 åˆ†é˜</strong> å®Œæˆã€‚å•å·å…·æœ‰<strong>è‡ªå‹•å„²å­˜åŠŸèƒ½</strong>ï¼Œ
                                    æ‚¨å¯éš¨æ™‚æš«åœï¼Œä¸‹æ¬¡é–‹å•Ÿæ™‚å°‡è‡ªå‹•æ¥çºŒä¸Šæ¬¡é€²åº¦ã€‚
                                </p>
                                <p class="text-sm text-amber-700 mt-2">
                                    ğŸ™ <strong>è¡·å¿ƒæ„Ÿè¬æ‚¨å¯¶è²´çš„æ™‚é–“èˆ‡å°ˆæ¥­æ„è¦‹ï¼Œæ‚¨çš„å”åŠ©å°æœ¬ç ”ç©¶è‡³é—œé‡è¦ï¼</strong>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-xl p-4 sm:p-6 mb-6">
                        <h3 class="font-bold text-slate-800 mb-4">ğŸ“‹ å•å·çµæ§‹</h3>
                        <div class="space-y-3 text-sm text-slate-600">
                            <div class="flex items-start gap-3">
                                <span class="w-6 h-6 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">1</span>
                                <div>
                                    <strong>å½±éŸ¿é—œä¿‚è©•ä¼°ï¼ˆDEMATELï¼‰</strong>
                                    <p class="text-slate-500">è©•ä¼° 12 é …æŒ‡æ¨™é–“çš„ç›¸äº’å½±éŸ¿ç¨‹åº¦ï¼Œå…± 132 é¡Œ</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="w-6 h-6 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">2</span>
                                <div>
                                    <strong>æ§‹é¢é‡è¦æ€§æ¯”è¼ƒï¼ˆANPï¼‰</strong>
                                    <p class="text-slate-500">æ¯”è¼ƒ 4 å€‹æ§‹é¢çš„ç›¸å°é‡è¦æ€§ï¼Œå…± 6 é¡Œ</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="w-6 h-6 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">3</span>
                                <div>
                                    <strong>æŒ‡æ¨™é‡è¦æ€§æ¯”è¼ƒï¼ˆANP å«ç›¸ä¾æ€§ï¼‰</strong>
                                    <p class="text-slate-500">åœ¨ä¸åŒæ§‹é¢å½±éŸ¿ä¸‹ï¼Œæ¯”è¼ƒæŒ‡æ¨™çš„ç›¸å°é‡è¦æ€§ï¼Œå…± 48 é¡Œ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç ”ç©¶æ¶æ§‹ -->
                    <div class="bg-slate-50 rounded-xl p-4 sm:p-6 mb-6">
                        <h3 class="font-bold text-slate-800 mb-3">ğŸ“Š ç ”ç©¶æ¶æ§‹ï¼šèˆå¼Šä¸‰è§’è«– + æ–‡æœ¬è¨Šè™Ÿ</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 text-sm">
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl mb-1">ğŸ’°</div>
                                <div class="font-medium text-slate-700">æ§‹é¢ A</div>
                                <div class="text-slate-500 text-xs">å£“åŠ›/å‹•æ©Ÿ</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl mb-1">ğŸšª</div>
                                <div class="font-medium text-slate-700">æ§‹é¢ B</div>
                                <div class="text-slate-500 text-xs">æ©Ÿæœƒ</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl mb-1">ğŸ­</div>
                                <div class="font-medium text-slate-700">æ§‹é¢ C</div>
                                <div class="text-slate-500 text-xs">æ…‹åº¦/è—‰å£</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl mb-1">ğŸ“</div>
                                <div class="font-medium text-slate-700">æ§‹é¢ D</div>
                                <div class="text-slate-500 text-xs">æ–‡æœ¬è¨Šè™Ÿ</div>
                            </div>
                        </div>
                    </div>

                    <!-- åŸºæœ¬è³‡æ–™ -->
                    <div class="border-t pt-6">
                        <h3 class="font-bold text-slate-800 mb-4">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
                        
                        <div class="grid sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    å§“å / ä»£è™Ÿ <span class="text-red-500">*</span>
                                </label>
                                <input v-model="respondent.name" type="text" 
                                    class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-transparent transition"
                                    placeholder="å¯ä½¿ç”¨ä»£è™Ÿä¿æŒåŒ¿å">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    æœå‹™å–®ä½é¡å‹ <span class="text-red-500">*</span>
                                </label>
                                <select v-model="respondent.organization" 
                                    class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-transparent transition">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="big4">å››å¤§æœƒè¨ˆå¸«äº‹å‹™æ‰€</option>
                                    <option value="other_cpa">å…¶ä»–æœƒè¨ˆå¸«äº‹å‹™æ‰€</option>
                                    <option value="listed_company">ä¸Šå¸‚æ«ƒå…¬å¸è²¡å‹™éƒ¨é–€</option>
                                    <option value="regulator">ä¸»ç®¡æ©Ÿé—œ</option>
                                    <option value="academia">å­¸è¡“å–®ä½</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    ç¶“é©—å¹´è³‡ <span class="text-red-500">*</span>
                                </label>
                                <select v-model="respondent.experience" 
                                    class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-transparent transition">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="5-10">5-10 å¹´</option>
                                    <option value="10-15">10-15 å¹´</option>
                                    <option value="15-20">15-20 å¹´</option>
                                    <option value="20+">20 å¹´ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    å¹´é½¡ <span class="text-slate-400 text-xs">ï¼ˆé¸å¡«ï¼‰</span>
                                </label>
                                <select v-model="respondent.age" 
                                    class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-transparent transition">
                                    <option value="">ä¸æä¾›</option>
                                    <option value="30-39">30-39 æ­²</option>
                                    <option value="40-49">40-49 æ­²</option>
                                    <option value="50-59">50-59 æ­²</option>
                                    <option value="60+">60 æ­²ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    æ€§åˆ¥ <span class="text-slate-400 text-xs">ï¼ˆé¸å¡«ï¼‰</span>
                                </label>
                                <select v-model="respondent.gender" 
                                    class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-transparent transition">
                                    <option value="">ä¸æä¾›</option>
                                    <option value="male">ç”·</option>
                                    <option value="female">å¥³</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    å¡«ç­”è£ç½®
                                </label>
                                <input type="text" :value="deviceType" disabled
                                    class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 text-slate-500">
                            </div>
                        </div>

                        <p class="text-xs text-slate-400 mt-2">
                            <span class="text-red-500">*</span> ç‚ºå¿…å¡«æ¬„ä½
                        </p>
                    </div>

                    <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <button v-if="hasSavedProgress" @click="clearProgress" 
                            class="text-sm text-slate-400 hover:text-red-500 transition-all underline order-2 sm:order-1">
                            ğŸ—‘ï¸ æ¸…é™¤èˆŠé€²åº¦ï¼Œé‡æ–°é–‹å§‹
                        </button>
                        <div v-else class="order-2 sm:order-1"></div>
                        <button @click="startSurvey" 
                            :disabled="!canStart"
                            :class="[
                                'w-full sm:w-auto px-8 py-4 rounded-xl font-bold text-lg transition-all order-1 sm:order-2',
                                canStart 
                                    ? 'bg-sky-600 text-white hover:bg-sky-700 hover:shadow-lg' 
                                    : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                            ]">
                            {{ hasSavedProgress ? 'ç¹¼çºŒå¡«ç­” â†’' : 'é–‹å§‹å¡«ç­” â†’' }}
                        </button>
                    </div>

                    <div v-if="hasSavedProgress" class="mt-4 bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-700">
                        ğŸ’¡ åµæ¸¬åˆ°æ‚¨æœ‰æœªå®Œæˆçš„å¡«ç­”é€²åº¦ï¼ˆ{{ savedProgressPercent }}%ï¼‰ï¼Œé»æ“Šã€Œç¹¼çºŒå¡«ç­”ã€å¯æ¥çºŒä¸Šæ¬¡é€²åº¦ã€‚
                    </div>
                </div>
            </transition>

            <!-- ==================== Stage 1: DEMATEL ==================== -->
            <transition name="fade" mode="out-in">
                <div v-if="currentStage === 1" key="dematel" class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                    <div class="mb-6">
                        <h2 class="text-lg sm:text-xl font-bold text-slate-800 mb-2">ç¬¬ä¸€éƒ¨åˆ†ï¼šå½±éŸ¿é—œä¿‚è©•ä¼°ï¼ˆDEMATELï¼‰</h2>
                        <p class="text-sm sm:text-base text-slate-600">
                            è«‹è©•ä¼°ã€Œ<span class="text-sky-600 font-medium">{{ currentFromCriteria.name }}</span>ã€
                            å°å…¶ä»–å„é …æŒ‡æ¨™çš„å½±éŸ¿ç¨‹åº¦
                        </p>
                    </div>

                    <!-- ç•¶å‰è©•ä¼°çš„æŒ‡æ¨™ -->
                    <div class="bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl p-4 sm:p-5 mb-4">
                        <p class="text-xs text-slate-500 mb-1">{{ currentFromCriteria.description }}</p>
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 sm:w-14 sm:h-14 bg-sky-600 text-white rounded-xl flex items-center justify-center font-bold text-lg sm:text-xl flex-shrink-0">
                                {{ currentFromCriteria.id }}
                            </div>
                            <h3 class="font-bold text-slate-800 text-base sm:text-lg">{{ currentFromCriteria.name }}</h3>
                        </div>
                    </div>

                    <!-- èªæ„é‡è¡¨èªªæ˜ -->
                    <div class="bg-slate-50 rounded-lg p-3 mb-4">
                        <p class="text-xs text-slate-600 text-center">
                            <strong>èªæ„é‡è¡¨ï¼š</strong>
                            ç„¡å½±éŸ¿(0) â†’ ä½åº¦(1) â†’ ä¸­åº¦(2) â†’ é«˜åº¦(3) â†’ æ¥µé«˜(4)
                        </p>
                    </div>

                    <!-- é€²åº¦ -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs sm:text-sm text-slate-500 mb-2">
                            <span>è©•ä¼°æŒ‡æ¨™ {{ dematelFromIndex + 1 }} / {{ criteria.length }}</span>
                            <span>DEMATEL æ•´é«” {{ Math.round(dematelProgress) }}%</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-sky-500 transition-all" :style="{width: dematelProgress + '%'}"></div>
                        </div>
                    </div>

                    <!-- å¡«ç­”å€ - å¡ç‰‡å¼ -->
                    <div class="space-y-3">
                        <template v-for="toCriteria in otherCriteria" :key="toCriteria.id">
                            <div class="border border-slate-200 rounded-xl p-4 card-hover">
                                <div class="mb-3">
                                    <p class="text-xs text-slate-400 mb-1">{{ toCriteria.description }}</p>
                                    <p class="text-sm sm:text-base text-slate-800">
                                        <span class="font-bold text-sky-600">{{ currentFromCriteria.id }}</span>
                                        â†’ å°ã€Œ<strong class="text-amber-600">{{ toCriteria.name }}</strong>ã€çš„å½±éŸ¿ç¨‹åº¦ï¼Ÿ
                                    </p>
                                </div>
                                
                                <!-- äº”é»èªæ„æŒ‰éˆ• -->
                                <div class="grid grid-cols-5 gap-1 sm:gap-2">
                                    <button v-for="level in fuzzyLevels" :key="level.value"
                                        @click="setDematelAnswer(currentFromCriteria.id, toCriteria.id, level.value)"
                                        :class="[
                                            'btn-option py-2 sm:py-3 rounded-lg text-xs sm:text-sm font-medium border-2 transition-all',
                                            dematelAnswers[currentFromCriteria.id][toCriteria.id] === level.value
                                                ? level.selectedClass
                                                : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'
                                        ]">
                                        <div class="font-bold">{{ level.value }}</div>
                                        <div class="text-xs hidden sm:block">{{ level.label }}</div>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- å°èˆª -->
                    <div class="mt-6 flex justify-between">
                        <button @click="prevDematel" 
                            :disabled="dematelFromIndex === 0"
                            :class="[
                                'px-4 sm:px-6 py-3 rounded-xl font-medium transition-all text-sm sm:text-base',
                                dematelFromIndex === 0 
                                    ? 'bg-slate-100 text-slate-400 cursor-not-allowed' 
                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                            ]">
                            â† ä¸Šä¸€çµ„
                        </button>
                        <button @click="nextDematel" 
                            class="px-4 sm:px-6 py-3 bg-sky-600 text-white rounded-xl font-medium hover:bg-sky-700 transition-all text-sm sm:text-base">
                            {{ dematelFromIndex === criteria.length - 1 ? 'é€²å…¥ä¸‹ä¸€éšæ®µ â†’' : 'ä¸‹ä¸€çµ„ â†’' }}
                        </button>
                    </div>
                </div>
            </transition>

            <!-- ==================== Stage 2: ANP æ§‹é¢æ¯”è¼ƒ ==================== -->
            <transition name="fade" mode="out-in">
                <div v-if="currentStage === 2" key="anp-dim" class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                    <div class="mb-6">
                        <h2 class="text-lg sm:text-xl font-bold text-slate-800 mb-2">ç¬¬äºŒéƒ¨åˆ†ï¼šæ§‹é¢é‡è¦æ€§æ¯”è¼ƒï¼ˆANPï¼‰</h2>
                        <p class="text-sm sm:text-base text-slate-600">
                            åœ¨åµæ¸¬è²¡å ±èˆå¼Šæ™‚ï¼Œè«‹æ¯”è¼ƒä»¥ä¸‹å…©å€‹æ§‹é¢çš„ç›¸å°é‡è¦æ€§
                        </p>
                    </div>

                    <!-- é€²åº¦ -->
                    <div class="mb-6">
                        <div class="flex justify-between text-xs sm:text-sm text-slate-500 mb-2">
                            <span>æ¯”è¼ƒ {{ anpDimIndex + 1 }} / {{ dimensionPairs.length }}</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-sky-500 transition-all" :style="{width: ((anpDimIndex + 1) / dimensionPairs.length * 100) + '%'}"></div>
                        </div>
                    </div>

                    <!-- æ¯”è¼ƒå¡ç‰‡ -->
                    <div class="grid sm:grid-cols-2 gap-4 mb-6">
                        <div class="bg-sky-50 border-2 border-sky-200 rounded-xl p-4 sm:p-5">
                            <p class="text-xs text-slate-500 mb-2">{{ currentDimPair.left.description }}</p>
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">{{ currentDimPair.left.emoji }}</div>
                                <div>
                                    <div class="text-xs text-slate-500">æ§‹é¢ {{ currentDimPair.left.id }}</div>
                                    <div class="font-bold text-slate-800">{{ currentDimPair.left.name }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 sm:p-5">
                            <p class="text-xs text-slate-500 mb-2">{{ currentDimPair.right.description }}</p>
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">{{ currentDimPair.right.emoji }}</div>
                                <div>
                                    <div class="text-xs text-slate-500">æ§‹é¢ {{ currentDimPair.right.id }}</div>
                                    <div class="font-bold text-slate-800">{{ currentDimPair.right.name }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANP ä¹é»é‡è¡¨ -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs sm:text-sm mb-2">
                            <span class="text-sky-600 font-medium">â† {{ currentDimPair.left.name }}</span>
                            <span class="text-slate-400">åŒç­‰</span>
                            <span class="text-amber-600 font-medium">{{ currentDimPair.right.name }} â†’</span>
                        </div>
                        <div class="grid grid-cols-9 gap-1">
                            <button v-for="val in 9" :key="val"
                                @click="anpDimAnswers[anpDimIndex] = val"
                                :class="[
                                    'py-2 sm:py-3 rounded-lg text-xs sm:text-sm font-bold border-2 transition-all',
                                    anpDimAnswers[anpDimIndex] === val
                                        ? (val < 5 ? 'bg-sky-500 border-sky-500 text-white' : val > 5 ? 'bg-amber-500 border-amber-500 text-white' : 'bg-slate-600 border-slate-600 text-white')
                                        : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'
                                ]">
                                {{ anpScaleLabels[val - 1] }}
                            </button>
                        </div>
                        <div class="flex justify-between text-xs text-slate-400 mt-1 px-1">
                            <span>æ¥µç«¯</span>
                            <span>éå¸¸</span>
                            <span>æ˜é¡¯</span>
                            <span>ç¨å¾®</span>
                            <span>1:1</span>
                            <span>ç¨å¾®</span>
                            <span>æ˜é¡¯</span>
                            <span>éå¸¸</span>
                            <span>æ¥µç«¯</span>
                        </div>
                    </div>

                    <!-- é¸æ“‡çµæœ -->
                    <div class="text-center mb-6">
                        <div class="inline-block px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm">
                            {{ anpDimResultText }}
                        </div>
                    </div>

                    <!-- å°èˆª -->
                    <div class="flex justify-between">
                        <button @click="anpDimIndex > 0 ? anpDimIndex-- : null" 
                            :disabled="anpDimIndex === 0"
                            :class="['px-4 sm:px-6 py-3 rounded-xl font-medium transition-all text-sm sm:text-base', anpDimIndex === 0 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 text-slate-600 hover:bg-slate-200']">
                            â† ä¸Šä¸€é¡Œ
                        </button>
                        <button @click="nextAnpDim" 
                            class="px-4 sm:px-6 py-3 bg-sky-600 text-white rounded-xl font-medium hover:bg-sky-700 transition-all text-sm sm:text-base">
                            {{ anpDimIndex === dimensionPairs.length - 1 ? 'é€²å…¥ä¸‹ä¸€éšæ®µ â†’' : 'ä¸‹ä¸€é¡Œ â†’' }}
                        </button>
                    </div>
                </div>
            </transition>

            <!-- ==================== Stage 3: ANP æŒ‡æ¨™æ¯”è¼ƒï¼ˆå«ç›¸ä¾æ€§ï¼‰ ==================== -->
            <transition name="fade" mode="out-in">
                <div v-if="currentStage === 3" key="anp-criteria" class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                    <div class="mb-6">
                        <h2 class="text-lg sm:text-xl font-bold text-slate-800 mb-2">ç¬¬ä¸‰éƒ¨åˆ†ï¼šæŒ‡æ¨™é‡è¦æ€§æ¯”è¼ƒï¼ˆANP å«ç›¸ä¾æ€§ï¼‰</h2>
                        <p class="text-sm sm:text-base text-slate-600">
                            åœ¨è€ƒé‡ã€Œ<span class="font-medium">{{ currentInfluenceDim.emoji }} {{ currentInfluenceDim.name }}</span>ã€æ§‹é¢çš„å½±éŸ¿ä¸‹ï¼Œ
                            è«‹æ¯”è¼ƒã€Œ<span class="text-sky-600 font-medium">{{ currentTargetDim.name }}</span>ã€æ§‹é¢å…§å„æŒ‡æ¨™çš„ç›¸å°é‡è¦æ€§
                        </p>
                    </div>

                    <!-- æƒ…å¢ƒèªªæ˜ -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-4 mb-4">
                        <p class="text-sm text-purple-800">
                            <strong>æƒ…å¢ƒï¼š</strong>ç•¶ã€Œ{{ currentInfluenceDim.name }}ã€å°ä¼æ¥­ç”¢ç”Ÿå½±éŸ¿æ™‚ï¼Œ
                            åœ¨ã€Œ{{ currentTargetDim.name }}ã€æ§‹é¢ä¸­ï¼Œä»¥ä¸‹å“ªå€‹æŒ‡æ¨™æ›´èƒ½åæ˜ èˆå¼Šé¢¨éšªï¼Ÿ
                        </p>
                    </div>

                    <!-- é€²åº¦ -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs sm:text-sm text-slate-500 mb-2">
                            <span>æƒ…å¢ƒ {{ anpCriteriaContextIndex + 1 }}/16ï¼Œæ¯”è¼ƒ {{ anpCriteriaPairIndex + 1 }}/3</span>
                            <span>ANP æŒ‡æ¨™ {{ Math.round(anpCriteriaProgress) }}%</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-sky-500 transition-all" :style="{width: anpCriteriaProgress + '%'}"></div>
                        </div>
                    </div>

                    <!-- æ¯”è¼ƒçš„å…©å€‹æŒ‡æ¨™ -->
                    <div class="grid sm:grid-cols-2 gap-4 mb-6">
                        <div class="bg-sky-50 border-2 border-sky-200 rounded-xl p-4">
                            <p class="text-xs text-slate-500 mb-2">{{ currentCriteriaPair.left.description }}</p>
                            <div class="flex items-center gap-2">
                                <span class="w-10 h-10 bg-sky-600 text-white rounded-lg flex items-center justify-center font-bold">
                                    {{ currentCriteriaPair.left.id }}
                                </span>
                                <span class="font-bold text-slate-800">{{ currentCriteriaPair.left.name }}</span>
                            </div>
                        </div>
                        <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
                            <p class="text-xs text-slate-500 mb-2">{{ currentCriteriaPair.right.description }}</p>
                            <div class="flex items-center gap-2">
                                <span class="w-10 h-10 bg-amber-600 text-white rounded-lg flex items-center justify-center font-bold">
                                    {{ currentCriteriaPair.right.id }}
                                </span>
                                <span class="font-bold text-slate-800">{{ currentCriteriaPair.right.name }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- ANP ä¹é»é‡è¡¨ -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs sm:text-sm mb-2">
                            <span class="text-sky-600 font-medium">â† {{ currentCriteriaPair.left.id }}</span>
                            <span class="text-slate-400">åŒç­‰</span>
                            <span class="text-amber-600 font-medium">{{ currentCriteriaPair.right.id }} â†’</span>
                        </div>
                        <div class="grid grid-cols-9 gap-1">
                            <button v-for="val in 9" :key="val"
                                @click="setAnpCriteriaAnswer(val)"
                                :class="[
                                    'py-2 sm:py-3 rounded-lg text-xs sm:text-sm font-bold border-2 transition-all',
                                    currentAnpCriteriaAnswer === val
                                        ? (val < 5 ? 'bg-sky-500 border-sky-500 text-white' : val > 5 ? 'bg-amber-500 border-amber-500 text-white' : 'bg-slate-600 border-slate-600 text-white')
                                        : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'
                                ]">
                                {{ anpScaleLabels[val - 1] }}
                            </button>
                        </div>
                    </div>

                    <!-- é¸æ“‡çµæœ -->
                    <div class="text-center mb-6">
                        <div class="inline-block px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm">
                            {{ anpCriteriaResultText }}
                        </div>
                    </div>

                    <!-- å°èˆª -->
                    <div class="flex justify-between">
                        <button @click="prevAnpCriteria" 
                            :disabled="anpCriteriaContextIndex === 0 && anpCriteriaPairIndex === 0"
                            :class="['px-4 sm:px-6 py-3 rounded-xl font-medium transition-all text-sm sm:text-base', 
                                (anpCriteriaContextIndex === 0 && anpCriteriaPairIndex === 0) ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 text-slate-600 hover:bg-slate-200']">
                            â† ä¸Šä¸€é¡Œ
                        </button>
                        <button @click="nextAnpCriteria" 
                            :disabled="submitting"
                            class="px-4 sm:px-6 py-3 bg-sky-600 text-white rounded-xl font-medium hover:bg-sky-700 transition-all text-sm sm:text-base disabled:bg-slate-400">
                            <span v-if="submitting">æäº¤ä¸­...</span>
                            <span v-else>{{ isLastAnpCriteria ? 'å®Œæˆå•å· â†’' : 'ä¸‹ä¸€é¡Œ â†’' }}</span>
                        </button>
                    </div>
                </div>
            </transition>

            <!-- ==================== Stage 4: å®Œæˆé  ==================== -->
            <transition name="fade" mode="out-in">
                <div v-if="currentStage === 4" key="complete" class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-800 mb-2">ğŸ‰ æ„Ÿè¬æ‚¨å®Œæˆå•å·ï¼</h1>
                        <p class="text-slate-600">æ‚¨çš„å°ˆæ¥­æ„è¦‹å°æœ¬ç ”ç©¶æ¥µç‚ºå¯¶è²´ï¼Œè¡·å¿ƒæ„Ÿè¬æ‚¨çš„å”åŠ©ï¼</p>
                    </div>

                    <!-- å¡«ç­”çµ±è¨ˆ -->
                    <div class="bg-slate-50 rounded-xl p-6 mb-6">
                        <h3 class="font-bold text-slate-800 mb-4">ğŸ“Š å¡«ç­”è³‡è¨Š</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-green-600">{{ elapsedTimeText }}</div>
                                <div class="text-sm text-slate-500">å¡«ç­”æ™‚é–“</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-amber-600">{{ surveyId.slice(0, 8) }}</div>
                                <div class="text-sm text-slate-500">å•å·ç·¨è™Ÿ</div>
                            </div>
                        </div>
                    </div>

                    <!-- æäº¤æˆåŠŸè¨Šæ¯ -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-6 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-xl">âœ…</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-green-800 mb-1">æ‚¨çš„å›ç­”å·²æˆåŠŸé€å‡ºï¼</h4>
                                <p class="text-sm text-green-700">
                                    æ„Ÿè¬æ‚¨å®Œæˆæœ¬å•å·ï¼Œæ‚¨çš„å°ˆæ¥­æ„è¦‹å·²å®‰å…¨å„²å­˜ã€‚ç ”ç©¶åœ˜éšŠå°‡å½™æ•´æ‰€æœ‰å°ˆå®¶æ„è¦‹å¾Œé€²è¡Œåˆ†æã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Fuzzy è½‰æ›èªªæ˜ -->
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 text-sm">
                        <h4 class="font-bold text-amber-800 mb-2">ğŸ“ Fuzzy ä¸‰è§’æ¨¡ç³Šæ•¸å°ç…§è¡¨ï¼ˆä¾›åƒè€ƒï¼‰</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-xs">
                            <div class="bg-white rounded p-2 text-center">
                                <div class="font-bold">0 ç„¡å½±éŸ¿</div>
                                <div class="text-slate-500">(0, 0, 0.25)</div>
                            </div>
                            <div class="bg-white rounded p-2 text-center">
                                <div class="font-bold">1 ä½åº¦</div>
                                <div class="text-slate-500">(0, 0.25, 0.5)</div>
                            </div>
                            <div class="bg-white rounded p-2 text-center">
                                <div class="font-bold">2 ä¸­åº¦</div>
                                <div class="text-slate-500">(0.25, 0.5, 0.75)</div>
                            </div>
                            <div class="bg-white rounded p-2 text-center">
                                <div class="font-bold">3 é«˜åº¦</div>
                                <div class="text-slate-500">(0.5, 0.75, 1)</div>
                            </div>
                            <div class="bg-white rounded p-2 text-center">
                                <div class="font-bold">4 æ¥µé«˜</div>
                                <div class="text-slate-500">(0.75, 1, 1)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

        </div>

        <!-- è‡ªå‹•å„²å­˜æç¤º -->
        <div v-if="showSaveToast" 
            class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50 text-sm">
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            å·²è‡ªå‹•å„²å­˜
        </div>
    </div>

    <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // ===== åŸºæœ¬ç‹€æ…‹ =====
            const loading = ref(true);
            const currentStage = ref(0);
            const showSaveToast = ref(false);
            const hasSavedProgress = ref(false);
            const savedProgressPercent = ref(0);
            const submitting = ref(false);

            // å”¯ä¸€è­˜åˆ¥ç¢¼èˆ‡æ™‚é–“
            const surveyId = ref('');
            const startTime = ref(null);
            const endTime = ref(null);

            // è£ç½®åµæ¸¬
            const deviceType = computed(() => {
                const ua = navigator.userAgent;
                if (/tablet|ipad|playbook|silk/i.test(ua)) return 'å¹³æ¿';
                if (/mobile|iphone|ipod|android|blackberry|opera mini|iemobile/i.test(ua)) return 'æ‰‹æ©Ÿ';
                return 'é›»è…¦';
            });

            // ===== å—è¨ªè€…è³‡æ–™ =====
            const respondent = ref({
                name: '', organization: '', experience: '', age: '', gender: ''
            });

            // ===== æ§‹é¢èˆ‡æŒ‡æ¨™å®šç¾© =====
            const dimensions = [
                { id: 'A', name: 'å£“åŠ›/å‹•æ©Ÿ', emoji: 'ğŸ’°', description: 'ã€Œå£“åŠ›/å‹•æ©Ÿã€æ˜¯æŒ‡ç®¡ç†å±¤é¢è‡¨çš„è²¡å‹™å£“åŠ›èˆ‡é”æˆç›®æ¨™çš„èª˜å› ã€‚' },
                { id: 'B', name: 'æ©Ÿæœƒ', emoji: 'ğŸšª', description: 'ã€Œæ©Ÿæœƒã€æ˜¯æŒ‡å…§æ§ç¼ºå¤±æˆ–çµ„ç¹”ç‰¹æ€§å‰µé€ çš„èˆå¼Šæ©Ÿæœƒã€‚' },
                { id: 'C', name: 'æ…‹åº¦/è—‰å£', emoji: 'ğŸ­', description: 'ã€Œæ…‹åº¦/è—‰å£ã€æ˜¯æŒ‡ç®¡ç†å±¤åˆç†åŒ–ä¸ç•¶è¡Œç‚ºçš„å¿ƒæ…‹èˆ‡è—‰å£ã€‚' },
                { id: 'D', name: 'æ–‡æœ¬è¨Šè™Ÿ', emoji: 'ğŸ“', description: 'ã€Œæ–‡æœ¬è¨Šè™Ÿã€æ˜¯æŒ‡å¹´å ±æ–‡æœ¬ä¸­å¯èƒ½éš±è—çš„ç•°å¸¸è¨Šè™Ÿã€‚' }
            ];

            const criteria = [
                { id: 'A1', dimension: 'A', name: 'è²¡å‹™å›°å¢ƒ', description: 'ã€Œè²¡å‹™å›°å¢ƒã€æ˜¯æŒ‡å…¬å¸é¢è‡¨çš„è²¡å‹™å£“åŠ›ç¨‹åº¦ï¼Œå¦‚ Z-scoreã€æµå‹•æ¯”ç‡ã€è² å‚µæ¯”ç‡ç­‰ã€‚' },
                { id: 'A2', dimension: 'A', name: 'ç›ˆåˆ©å£“åŠ›', description: 'ã€Œç›ˆåˆ©å£“åŠ›ã€æ˜¯æŒ‡é”æˆç›ˆåˆ©ç›®æ¨™çš„å£“åŠ›ï¼Œå¦‚æ˜¯å¦å‹‰å¼·é”åˆ°åˆ†æå¸«é æ¸¬ã€‚' },
                { id: 'A3', dimension: 'A', name: 'è–ªé…¬çµæ§‹', description: 'ã€Œè–ªé…¬çµæ§‹ã€æ˜¯æŒ‡ç®¡ç†å±¤è–ªé…¬èˆ‡è‚¡åƒ¹æˆ–ç¸¾æ•ˆçš„é€£çµç¨‹åº¦ã€‚' },
                { id: 'B1', dimension: 'B', name: 'é—œä¿‚äººäº¤æ˜“', description: 'ã€Œé—œä¿‚äººäº¤æ˜“ã€æ˜¯æŒ‡é—œä¿‚äººäº¤æ˜“çš„é‡‘é¡ã€é »ç‡èˆ‡æ€§è³ªã€‚' },
                { id: 'B2', dimension: 'B', name: 'å…§æ§ç¼ºå¤±', description: 'ã€Œå…§æ§ç¼ºå¤±ã€æ˜¯æŒ‡å…§éƒ¨æ§åˆ¶åˆ¶åº¦çš„æœ‰æ•ˆæ€§èˆ‡é‡å¤§ç¼ºå¤±ã€‚' },
                { id: 'B3', dimension: 'B', name: 'è¤‡é›œçµæ§‹', description: 'ã€Œè¤‡é›œçµæ§‹ã€æ˜¯æŒ‡çµ„ç¹”æ¶æ§‹çš„è¤‡é›œç¨‹åº¦ï¼Œå¦‚å¤šå±¤å­å…¬å¸ã€æµ·å¤–å¯¦é«”ç­‰ã€‚' },
                { id: 'C1', dimension: 'C', name: 'å¯©è¨ˆæ›´æ›', description: 'ã€Œå¯©è¨ˆæ›´æ›ã€æ˜¯æŒ‡æ›´æ›å¯©è¨ˆå¸«çš„é »ç‡èˆ‡åŸå› ã€‚' },
                { id: 'C2', dimension: 'C', name: 'é‡ç·¨ç´€éŒ„', description: 'ã€Œé‡ç·¨ç´€éŒ„ã€æ˜¯æŒ‡æ­·å²è²¡å ±é‡ç·¨çš„æ¬¡æ•¸èˆ‡æ€§è³ªã€‚' },
                { id: 'C3', dimension: 'C', name: 'ç®¡ç†å±¤èª ä¿¡', description: 'ã€Œç®¡ç†å±¤èª ä¿¡ã€æ˜¯æŒ‡ç®¡ç†å±¤çš„èª ä¿¡ç´€éŒ„èˆ‡è£ç½°æ­·å²ã€‚' },
                { id: 'D1', dimension: 'D', name: 'èªè¨€æ¨¡ç³Šæ€§', description: 'ã€Œèªè¨€æ¨¡ç³Šæ€§ã€æ˜¯æŒ‡å¹´å ±æ–‡æœ¬çš„æ¨¡ç³Šç¨‹åº¦èˆ‡æ¨¡ç³Šè©å½™ä½¿ç”¨é »ç‡ã€‚' },
                { id: 'D2', dimension: 'D', name: 'æƒ…ç·’ç•°å¸¸', description: 'ã€Œæƒ…ç·’ç•°å¸¸ã€æ˜¯æŒ‡æ–‡æœ¬æƒ…ç·’èˆ‡è²¡å‹™è¡¨ç¾çš„ä¸ä¸€è‡´ç¨‹åº¦ã€‚' },
                { id: 'D3', dimension: 'D', name: 'è¤‡é›œå¥å‹', description: 'ã€Œè¤‡é›œå¥å‹ã€æ˜¯æŒ‡æ–‡æœ¬å¥å‹çš„è¤‡é›œåº¦èˆ‡å¯è®€æ€§ã€‚' }
            ];

            const stages = [
                { title: 'æ­¡è¿', subtitle: 'å•å·èªªæ˜', short: 'é–‹å§‹' },
                { title: 'DEMATEL', subtitle: 'å½±éŸ¿é—œä¿‚è©•ä¼°', short: 'DEMATEL' },
                { title: 'ANP æ§‹é¢', subtitle: 'æ§‹é¢é‡è¦æ€§', short: 'æ§‹é¢' },
                { title: 'ANP æŒ‡æ¨™', subtitle: 'æŒ‡æ¨™é‡è¦æ€§ï¼ˆå«ç›¸ä¾æ€§ï¼‰', short: 'æŒ‡æ¨™' },
                { title: 'å®Œæˆ', subtitle: 'æ„Ÿè¬æ‚¨', short: 'å®Œæˆ' }
            ];

            // Fuzzy èªæ„é‡è¡¨
            const fuzzyLevels = [
                { value: 0, label: 'ç„¡å½±éŸ¿', tfn: [0, 0, 0.25], selectedClass: 'bg-slate-500 border-slate-500 text-white selected' },
                { value: 1, label: 'ä½åº¦', tfn: [0, 0.25, 0.5], selectedClass: 'bg-green-500 border-green-500 text-white selected' },
                { value: 2, label: 'ä¸­åº¦', tfn: [0.25, 0.5, 0.75], selectedClass: 'bg-yellow-500 border-yellow-500 text-white selected' },
                { value: 3, label: 'é«˜åº¦', tfn: [0.5, 0.75, 1], selectedClass: 'bg-orange-500 border-orange-500 text-white selected' },
                { value: 4, label: 'æ¥µé«˜', tfn: [0.75, 1, 1], selectedClass: 'bg-red-500 border-red-500 text-white selected' }
            ];

            const anpScaleLabels = ['9', '7', '5', '3', '1', '3', '5', '7', '9'];

            // ===== DEMATEL =====
            const dematelFromIndex = ref(0);
            const dematelAnswers = ref({});

            const initDematel = () => {
                criteria.forEach(from => {
                    dematelAnswers.value[from.id] = {};
                    criteria.forEach(to => {
                        if (from.id !== to.id) {
                            dematelAnswers.value[from.id][to.id] = 2; // é è¨­ä¸­åº¦
                        }
                    });
                });
            };

            const currentFromCriteria = computed(() => criteria[dematelFromIndex.value]);
            const otherCriteria = computed(() => criteria.filter(c => c.id !== currentFromCriteria.value.id));
            const dematelProgress = computed(() => ((dematelFromIndex.value + 1) / criteria.length) * 100);

            const setDematelAnswer = (from, to, value) => {
                dematelAnswers.value[from][to] = value;
                autoSave();
            };

            const prevDematel = () => { if (dematelFromIndex.value > 0) dematelFromIndex.value--; };
            const nextDematel = () => {
                if (dematelFromIndex.value < criteria.length - 1) {
                    dematelFromIndex.value++;
                } else {
                    currentStage.value = 2;
                }
                autoSave();
            };

            // ===== ANP æ§‹é¢æ¯”è¼ƒ =====
            const anpDimIndex = ref(0);
            const anpDimAnswers = ref([5, 5, 5, 5, 5, 5]); // é è¨­åŒç­‰é‡è¦

            const dimensionPairs = [
                { left: dimensions[0], right: dimensions[1] },
                { left: dimensions[0], right: dimensions[2] },
                { left: dimensions[0], right: dimensions[3] },
                { left: dimensions[1], right: dimensions[2] },
                { left: dimensions[1], right: dimensions[3] },
                { left: dimensions[2], right: dimensions[3] }
            ];

            const currentDimPair = computed(() => dimensionPairs[anpDimIndex.value]);

            const anpDimResultText = computed(() => {
                const val = anpDimAnswers.value[anpDimIndex.value];
                const left = currentDimPair.value.left.name;
                const right = currentDimPair.value.right.name;
                if (val === 5) return `${left} èˆ‡ ${right} åŒç­‰é‡è¦`;
                if (val < 5) return `${left} æ¯” ${right} é‡è¦ï¼ˆ${anpScaleLabels[val - 1]} å€ï¼‰`;
                return `${right} æ¯” ${left} é‡è¦ï¼ˆ${anpScaleLabels[val - 1]} å€ï¼‰`;
            });

            const nextAnpDim = () => {
                if (anpDimIndex.value < dimensionPairs.length - 1) {
                    anpDimIndex.value++;
                } else {
                    currentStage.value = 3;
                }
                autoSave();
            };

            // ===== ANP æŒ‡æ¨™æ¯”è¼ƒï¼ˆå«ç›¸ä¾æ€§ï¼‰=====
            // çµæ§‹ï¼šå°æ–¼æ¯å€‹æ§‹é¢ Xï¼Œå•ã€Œåœ¨ X å½±éŸ¿ä¸‹ï¼ŒY æ§‹é¢å…§çš„æŒ‡æ¨™æ¯”è¼ƒã€
            // å…± 4Ã—4Ã—3 = 48 é¡Œï¼ˆæ¯å€‹å½±éŸ¿æ§‹é¢ Ã— æ¯å€‹è¢«å½±éŸ¿æ§‹é¢ Ã— 3 å°æŒ‡æ¨™ï¼‰
            const anpCriteriaContextIndex = ref(0); // 0-15 (4Ã—4 æƒ…å¢ƒ)
            const anpCriteriaPairIndex = ref(0); // 0-2 (æ¯æƒ…å¢ƒ 3 å°)
            const anpCriteriaAnswers = ref({});

            const initAnpCriteria = () => {
                // çµæ§‹: { "A_A": [5,5,5], "A_B": [5,5,5], ... }
                dimensions.forEach(influence => {
                    dimensions.forEach(target => {
                        anpCriteriaAnswers.value[`${influence.id}_${target.id}`] = [5, 5, 5];
                    });
                });
            };

            // è¨ˆç®—ç•¶å‰æƒ…å¢ƒçš„å½±éŸ¿æ§‹é¢å’Œç›®æ¨™æ§‹é¢
            const currentInfluenceDim = computed(() => {
                const influenceIdx = Math.floor(anpCriteriaContextIndex.value / 4);
                return dimensions[influenceIdx];
            });

            const currentTargetDim = computed(() => {
                const targetIdx = anpCriteriaContextIndex.value % 4;
                return dimensions[targetIdx];
            });

            const currentTargetCriteria = computed(() => {
                return criteria.filter(c => c.dimension === currentTargetDim.value.id);
            });

            const currentCriteriaPair = computed(() => {
                const cs = currentTargetCriteria.value;
                const pairs = [
                    { left: cs[0], right: cs[1] },
                    { left: cs[0], right: cs[2] },
                    { left: cs[1], right: cs[2] }
                ];
                return pairs[anpCriteriaPairIndex.value];
            });

            const currentAnpCriteriaAnswer = computed(() => {
                const key = `${currentInfluenceDim.value.id}_${currentTargetDim.value.id}`;
                return anpCriteriaAnswers.value[key][anpCriteriaPairIndex.value];
            });

            const setAnpCriteriaAnswer = (val) => {
                const key = `${currentInfluenceDim.value.id}_${currentTargetDim.value.id}`;
                anpCriteriaAnswers.value[key][anpCriteriaPairIndex.value] = val;
                autoSave();
            };

            const anpCriteriaProgress = computed(() => {
                const total = 16 * 3; // 48 é¡Œ
                const done = anpCriteriaContextIndex.value * 3 + anpCriteriaPairIndex.value + 1;
                return (done / total) * 100;
            });

            const anpCriteriaResultText = computed(() => {
                const val = currentAnpCriteriaAnswer.value;
                const left = currentCriteriaPair.value.left;
                const right = currentCriteriaPair.value.right;
                if (val === 5) return `${left.id} ${left.name} èˆ‡ ${right.id} ${right.name} åŒç­‰é‡è¦`;
                if (val < 5) return `${left.id} æ¯” ${right.id} é‡è¦ï¼ˆ${anpScaleLabels[val - 1]} å€ï¼‰`;
                return `${right.id} æ¯” ${left.id} é‡è¦ï¼ˆ${anpScaleLabels[val - 1]} å€ï¼‰`;
            });

            const isLastAnpCriteria = computed(() => {
                return anpCriteriaContextIndex.value === 15 && anpCriteriaPairIndex.value === 2;
            });

            const prevAnpCriteria = () => {
                if (anpCriteriaPairIndex.value > 0) {
                    anpCriteriaPairIndex.value--;
                } else if (anpCriteriaContextIndex.value > 0) {
                    anpCriteriaContextIndex.value--;
                    anpCriteriaPairIndex.value = 2;
                }
            };

            const nextAnpCriteria = async () => {
                if (anpCriteriaPairIndex.value < 2) {
                    anpCriteriaPairIndex.value++;
                } else if (anpCriteriaContextIndex.value < 15) {
                    anpCriteriaContextIndex.value++;
                    anpCriteriaPairIndex.value = 0;
                } else {
                    // å®Œæˆå•å·ï¼Œæäº¤åˆ°ä¼ºæœå™¨
                    endTime.value = new Date();
                    submitting.value = true;
                    
                    const data = {
                        surveyId: surveyId.value,
                        startTime: startTime.value?.toISOString(),
                        endTime: endTime.value?.toISOString(),
                        respondent: respondent.value,
                        deviceType: deviceType.value,
                        dematelAnswers: dematelAnswers.value,
                        anpDimAnswers: anpDimAnswers.value,
                        anpCriteriaAnswers: anpCriteriaAnswers.value,
                        status: 'completed'
                    };
                    
                    try {
                        const res = await fetch('/api/survey/submit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await res.json();
                        if (result.success) {
                            // æ¸…é™¤æœ¬æ©Ÿå„²å­˜
                            localStorage.removeItem('fuzzy_danp_survey');
                            currentStage.value = 4;
                        } else {
                            alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                        }
                    } catch (e) {
                        console.error('Submit error:', e);
                        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œå†è©¦');
                    }
                    
                    submitting.value = false;
                    return;
                }
                autoSave();
            };

            // ===== æ•´é«”é€²åº¦ =====
            const totalQuestions = 132 + 6 + 48;
            const overallProgress = computed(() => {
                if (currentStage.value === 0) return 0;
                if (currentStage.value === 4) return 100;
                
                let p = 0;
                // DEMATEL: 71% (132/186)
                if (currentStage.value >= 1) {
                    p += (dematelFromIndex.value / 12) * 71;
                }
                if (currentStage.value > 1) p = 71;
                
                // ANP Dim: 3% (6/186)
                if (currentStage.value >= 2) {
                    p += (anpDimIndex.value / 6) * 3;
                }
                if (currentStage.value > 2) p = 74;
                
                // ANP Criteria: 26% (48/186)
                if (currentStage.value >= 3) {
                    p += (anpCriteriaProgress.value / 100) * 26;
                }
                
                return Math.min(100, p);
            });

            const estimatedTime = computed(() => {
                // è®“é ä¼°æ™‚é–“é¡¯ç¤ºæ›´èˆ’é©ï¼Œä¸è¦ä¸€é–‹å§‹å°±é¡¯ç¤ºå¾ˆå¤§çš„æ•¸å­—
                const progress = overallProgress.value;
                if (progress < 5) return '25-30';  // å‰›é–‹å§‹
                if (progress < 20) return '20-25';
                if (progress < 40) return '15-20';
                if (progress < 60) return '10-15';
                if (progress < 80) return '5-10';
                if (progress < 95) return '< 5';
                return '< 1';
            });

            const elapsedTimeText = computed(() => {
                if (!startTime.value || !endTime.value) return '-';
                const diff = Math.round((endTime.value - startTime.value) / 60000);
                return `${diff} åˆ†é˜`;
            });

            // ===== é©—è­‰èˆ‡é–‹å§‹ =====
            const canStart = computed(() => {
                return respondent.value.name && respondent.value.organization && respondent.value.experience;
            });

            const startSurvey = () => {
                if (canStart.value) {
                    if (!startTime.value) startTime.value = new Date();
                    if (!surveyId.value) surveyId.value = generateUUID();
                    currentStage.value = 1;
                    autoSave();
                }
            };

            const generateUUID = () => {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
            };

            // ===== å„²å­˜èˆ‡è¼‰å…¥ =====
            const autoSave = async () => {
                const data = {
                    surveyId: surveyId.value,
                    startTime: startTime.value?.toISOString(),
                    respondent: respondent.value,
                    deviceType: deviceType.value,
                    currentStage: currentStage.value,
                    dematelFromIndex: dematelFromIndex.value,
                    dematelAnswers: dematelAnswers.value,
                    anpDimIndex: anpDimIndex.value,
                    anpDimAnswers: anpDimAnswers.value,
                    anpCriteriaContextIndex: anpCriteriaContextIndex.value,
                    anpCriteriaPairIndex: anpCriteriaPairIndex.value,
                    anpCriteriaAnswers: anpCriteriaAnswers.value,
                    status: 'in_progress',
                    savedAt: new Date().toISOString()
                };
                
                // å„²å­˜åˆ°æœ¬æ©Ÿ
                localStorage.setItem('fuzzy_danp_survey', JSON.stringify(data));
                
                // ä¸Šå‚³åˆ°ä¼ºæœå™¨
                try {
                    await fetch('/api/survey/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } catch (e) {
                    console.log('ä¼ºæœå™¨å„²å­˜å¤±æ•—ï¼Œå·²å„²å­˜è‡³æœ¬æ©Ÿ', e);
                }
                
                showSaveToast.value = true;
                setTimeout(() => showSaveToast.value = false, 1500);
            };

            const loadProgress = () => {
                const saved = localStorage.getItem('fuzzy_danp_survey');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        surveyId.value = data.surveyId || generateUUID();
                        if (data.startTime) startTime.value = new Date(data.startTime);
                        respondent.value = data.respondent || respondent.value;
                        currentStage.value = data.currentStage || 0;
                        dematelFromIndex.value = data.dematelFromIndex || 0;
                        dematelAnswers.value = data.dematelAnswers || dematelAnswers.value;
                        anpDimIndex.value = data.anpDimIndex || 0;
                        anpDimAnswers.value = data.anpDimAnswers || anpDimAnswers.value;
                        anpCriteriaContextIndex.value = data.anpCriteriaContextIndex || 0;
                        anpCriteriaPairIndex.value = data.anpCriteriaPairIndex || 0;
                        anpCriteriaAnswers.value = data.anpCriteriaAnswers || anpCriteriaAnswers.value;
                        hasSavedProgress.value = true;
                        
                        // è¨ˆç®—å·²å„²å­˜é€²åº¦ç™¾åˆ†æ¯”
                        let p = 0;
                        if (data.currentStage >= 1) p += (data.dematelFromIndex / 12) * 71;
                        if (data.currentStage > 1) p = 71;
                        if (data.currentStage >= 2) p += (data.anpDimIndex / 6) * 3;
                        if (data.currentStage > 2) p = 74;
                        if (data.currentStage >= 3) {
                            const done = data.anpCriteriaContextIndex * 3 + data.anpCriteriaPairIndex;
                            p += (done / 48) * 26;
                        }
                        savedProgressPercent.value = Math.round(p);
                    } catch (e) { console.error(e); }
                }
            };

            const clearProgress = () => {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡«ç­”é€²åº¦å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    localStorage.removeItem('fuzzy_danp_survey');
                    location.reload();
                }
            };

            // ===== åŒ¯å‡º =====
            const exportFullJSON = () => {
                const data = {
                    meta: {
                        surveyId: surveyId.value,
                        version: '1.0',
                        exportTime: new Date().toISOString(),
                        startTime: startTime.value?.toISOString(),
                        endTime: endTime.value?.toISOString(),
                        device: deviceType.value
                    },
                    respondent: respondent.value,
                    dematel: {
                        answers: dematelAnswers.value,
                        fuzzyScale: fuzzyLevels.map(l => ({ value: l.value, label: l.label, tfn: l.tfn }))
                    },
                    anp: {
                        dimensionComparisons: anpDimAnswers.value,
                        dimensionPairs: dimensionPairs.map(p => `${p.left.id}_vs_${p.right.id}`),
                        criteriaComparisons: anpCriteriaAnswers.value
                    },
                    criteria: criteria,
                    dimensions: dimensions
                };
                downloadFile(JSON.stringify(data, null, 2), `fuzzy_danp_${surveyId.value}.json`, 'application/json');
            };

            const exportDematelCSV = () => {
                let csv = 'From,To,Value,Label,TFN_L,TFN_M,TFN_U\n';
                criteria.forEach(from => {
                    criteria.forEach(to => {
                        if (from.id !== to.id) {
                            const val = dematelAnswers.value[from.id][to.id];
                            const level = fuzzyLevels[val];
                            csv += `${from.id},${to.id},${val},${level.label},${level.tfn[0]},${level.tfn[1]},${level.tfn[2]}\n`;
                        }
                    });
                });
                downloadFile(csv, `dematel_${surveyId.value}.csv`, 'text/csv');
            };

            const exportANPCSV = () => {
                let csv = 'Type,Context,Left,Right,Value,Interpretation\n';
                
                // æ§‹é¢æ¯”è¼ƒ
                dimensionPairs.forEach((pair, i) => {
                    const val = anpDimAnswers.value[i];
                    csv += `Dimension,-,${pair.left.id},${pair.right.id},${val},${val < 5 ? pair.left.id + ' preferred' : val > 5 ? pair.right.id + ' preferred' : 'Equal'}\n`;
                });
                
                // æŒ‡æ¨™æ¯”è¼ƒ
                dimensions.forEach(influence => {
                    dimensions.forEach(target => {
                        const key = `${influence.id}_${target.id}`;
                        const answers = anpCriteriaAnswers.value[key];
                        const cs = criteria.filter(c => c.dimension === target.id);
                        const pairs = [[cs[0], cs[1]], [cs[0], cs[2]], [cs[1], cs[2]]];
                        pairs.forEach((pair, i) => {
                            const val = answers[i];
                            csv += `Criteria,${key},${pair[0].id},${pair[1].id},${val},${val < 5 ? pair[0].id + ' preferred' : val > 5 ? pair[1].id + ' preferred' : 'Equal'}\n`;
                        });
                    });
                });
                
                downloadFile(csv, `anp_${surveyId.value}.csv`, 'text/csv');
            };

            const downloadFile = (content, filename, type) => {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            };

            // ===== åˆå§‹åŒ– =====
            onMounted(() => {
                initDematel();
                initAnpCriteria();
                loadProgress();
                if (!surveyId.value) surveyId.value = generateUUID();
                setTimeout(() => loading.value = false, 500);
            });

            return {
                loading, currentStage, showSaveToast, hasSavedProgress, savedProgressPercent, submitting,
                surveyId, deviceType, respondent, dimensions, criteria, stages,
                fuzzyLevels, anpScaleLabels, elapsedTimeText,
                
                // DEMATEL
                dematelFromIndex, dematelAnswers, currentFromCriteria, otherCriteria,
                dematelProgress, setDematelAnswer, prevDematel, nextDematel,
                
                // ANP Dim
                anpDimIndex, anpDimAnswers, dimensionPairs, currentDimPair,
                anpDimResultText, nextAnpDim,
                
                // ANP Criteria
                anpCriteriaContextIndex, anpCriteriaPairIndex, currentInfluenceDim, currentTargetDim,
                currentCriteriaPair, currentAnpCriteriaAnswer, setAnpCriteriaAnswer,
                anpCriteriaProgress, anpCriteriaResultText, isLastAnpCriteria,
                prevAnpCriteria, nextAnpCriteria,
                
                // Progress & Actions
                overallProgress, estimatedTime, canStart, startSurvey, clearProgress,
                exportFullJSON, exportDematelCSV, exportANPCSV
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
