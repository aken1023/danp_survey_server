<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy DANP å•å·ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="app">
        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-sky-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold">FD</span>
                        </div>
                        <div>
                            <h1 class="font-bold text-slate-800">Fuzzy DANP å•å·ç®¡ç†å¾Œå°</h1>
                            <p class="text-xs text-slate-500">è²¡å ±èˆå¼Šé¢¨éšªæŒ‡æ¨™å°ˆå®¶å•å·</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="refreshData" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition">
                            ğŸ”„ é‡æ–°æ•´ç†
                        </button>
                        <button @click="logout" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                            ğŸšª ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ç™»å…¥æª¢æŸ¥é®ç½© -->
        <div v-if="!authenticated" class="fixed inset-0 bg-white flex items-center justify-center z-50">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-slate-600">é©—è­‰ç®¡ç†å“¡æ¬Šé™ä¸­...</p>
            </div>
        </div>

        <div v-else class="max-w-7xl mx-auto px-4 py-6">
            <!-- æ“´å±•çµ±è¨ˆå¡ç‰‡ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">ç¸½å¡«ç­”æ•¸</p>
                            <p class="text-3xl font-bold text-slate-800">{{ stats.total }}</p>
                        </div>
                        <div class="w-12 h-12 bg-sky-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">ğŸ“‹</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">å·²å®Œæˆ</p>
                            <p class="text-3xl font-bold text-green-600">{{ stats.completed }}</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">âœ…</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">å¡«ç­”ä¸­</p>
                            <p class="text-3xl font-bold text-amber-600">{{ stats.inProgress }}</p>
                        </div>
                        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">â³</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">å¹³å‡æ™‚é–“</p>
                            <p class="text-3xl font-bold text-purple-600">{{ analytics.summary?.avgDuration || 0 }}</p>
                            <p class="text-xs text-slate-400">åˆ†é˜</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">â±ï¸</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœ–è¡¨åˆ†æå€ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- æ¯æ—¥å¡«å¯«è¶¨å‹¢ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">ğŸ“ˆ æ¯æ—¥å¡«å¯«è¶¨å‹¢</h3>
                    <canvas id="dailyChart" width="400" height="200"></canvas>
                </div>

                <!-- è¨­å‚™é¡å‹åˆ†å¸ƒ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">ğŸ“± è¨­å‚™é¡å‹åˆ†å¸ƒ</h3>
                    <canvas id="deviceChart" width="400" height="200"></canvas>
                </div>

                <!-- å¡«å¯«æ™‚é–“åˆ†æ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">â° å¡«å¯«æ™‚é–“åˆ†å¸ƒ</h3>
                    <canvas id="timeChart" width="400" height="200"></canvas>
                </div>

                <!-- æ©Ÿæ§‹åˆ†å¸ƒ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">ğŸ¢ æ©Ÿæ§‹åˆ†å¸ƒ</h3>
                    <canvas id="orgChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- åŒ¯å‡ºæŒ‰éˆ•å€ -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="font-bold text-slate-800 mb-4">ğŸ“¥ åŒ¯å‡ºè³‡æ–™</h2>

                <!-- åŒ¯å‡ºé¸é …åˆ‡æ› -->
                <div class="flex items-center gap-4 mb-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" v-model="includeIncomplete"
                            class="w-4 h-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500">
                        <span class="text-sm text-slate-700">åŒ…å«æœªå®Œæˆå•å·</span>
                    </label>
                </div>

                <div class="flex flex-wrap gap-3">
                    <a @click="downloadExport('json')"
                       class="px-6 py-3 bg-sky-600 text-white rounded-lg font-medium hover:bg-sky-700 transition inline-flex items-center gap-2 cursor-pointer">
                        ğŸ“„ åŒ¯å‡ºå®Œæ•´ JSON
                    </a>
                    <a @click="downloadExport('dematel-csv')"
                       class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition inline-flex items-center gap-2 cursor-pointer">
                        ğŸ“Š åŒ¯å‡º DEMATEL CSV
                    </a>
                    <a @click="downloadExport('anp-csv')"
                       class="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition inline-flex items-center gap-2 cursor-pointer">
                        ğŸ“Š åŒ¯å‡º ANP CSV
                    </a>
                </div>
                <p class="text-sm text-slate-500 mt-3">
                    {{ includeIncomplete ? '* å°‡åŒ¯å‡ºå…¨éƒ¨å•å·ï¼ˆå«æœªå®Œæˆï¼‰' : '* åƒ…åŒ¯å‡ºå·²å®Œæˆçš„å•å·' }}
                </p>
            </div>

            <!-- å¡«ç­”åˆ—è¡¨ -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-6 border-b">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <h2 class="font-bold text-slate-800">ğŸ“ å¡«ç­”è¨˜éŒ„</h2>

                        <!-- æœç´¢å’Œç¯©é¸å€ -->
                        <div class="flex flex-wrap gap-3">
                            <!-- æœç´¢æ¡† -->
                            <input v-model="searchText"
                                type="text"
                                placeholder="æœå°‹å§“å..."
                                class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none w-40">

                            <!-- æ©Ÿæ§‹ç¯©é¸ -->
                            <select v-model="filterOrg" class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 outline-none">
                                <option value="">å…¨éƒ¨æ©Ÿæ§‹</option>
                                <option value="big4">å››å¤§æœƒè¨ˆå¸«äº‹å‹™æ‰€</option>
                                <option value="other_cpa">å…¶ä»–æœƒè¨ˆå¸«äº‹å‹™æ‰€</option>
                                <option value="listed_company">ä¸Šå¸‚æ«ƒå…¬å¸</option>
                                <option value="regulator">ä¸»ç®¡æ©Ÿé—œ</option>
                                <option value="academia">å­¸è¡“å–®ä½</option>
                                <option value="other">å…¶ä»–</option>
                            </select>

                            <!-- ç‹€æ…‹ç¯©é¸ -->
                            <select v-model="filterStatus" class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 outline-none">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="completed">å·²å®Œæˆ</option>
                                <option value="in_progress">å¡«ç­”ä¸­</option>
                            </select>

                            <!-- æ¸…é™¤ç¯©é¸ -->
                            <button v-if="searchText || filterOrg || filterStatus"
                                @click="clearFilters"
                                class="px-3 py-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition">
                                âœ• æ¸…é™¤
                            </button>
                        </div>
                    </div>

                    <!-- ç¯©é¸çµæœçµ±è¨ˆ -->
                    <div v-if="searchText || filterOrg || filterStatus" class="mt-3 text-sm text-slate-500">
                        ç¯©é¸çµæœï¼š{{ filteredResponses.length }} ç­† / ç¸½å…± {{ responses.length }} ç­†
                    </div>
                </div>
                
                <!-- æ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
                <div v-if="selectedIds.length > 0" class="px-6 py-3 bg-sky-50 border-b flex items-center gap-4">
                    <span class="text-sm text-sky-700 font-medium">å·²é¸æ“‡ {{ selectedIds.length }} ç­†</span>
                    <button @click="batchExport"
                        class="px-4 py-1.5 bg-sky-600 text-white rounded-lg text-sm hover:bg-sky-700 transition">
                        åŒ¯å‡ºé¸å–
                    </button>
                    <button @click="batchDelete"
                        class="px-4 py-1.5 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition">
                        åˆªé™¤é¸å–
                    </button>
                    <button @click="clearSelection"
                        class="px-4 py-1.5 text-slate-600 hover:bg-slate-200 rounded-lg text-sm transition">
                        å–æ¶ˆé¸å–
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left">
                                    <input type="checkbox"
                                        :checked="isAllSelected"
                                        @change="toggleSelectAll"
                                        class="w-4 h-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å¡«ç­”è€…</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å–®ä½</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å¹´è³‡</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">è£ç½®</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ›´æ–°æ™‚é–“</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-if="filteredResponses.length === 0">
                                <td colspan="8" class="px-4 py-8 text-center text-slate-500">
                                    {{ responses.length === 0 ? 'å°šç„¡å¡«ç­”è¨˜éŒ„' : 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„' }}
                                </td>
                            </tr>
                            <tr v-for="r in filteredResponses" :key="r.survey_id"
                                :class="['hover:bg-slate-50', selectedIds.includes(r.survey_id) ? 'bg-sky-50' : '']">
                                <td class="px-4 py-4">
                                    <input type="checkbox"
                                        :checked="selectedIds.includes(r.survey_id)"
                                        @change="toggleSelect(r.survey_id)"
                                        class="w-4 h-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500">
                                </td>
                                <td class="px-4 py-4">
                                    <div class="font-medium text-slate-800">{{ r.respondent_name || '(æœªå¡«)' }}</div>
                                    <div class="text-xs text-slate-400">{{ r.survey_id.slice(0, 8) }}...</div>
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-600">{{ formatOrg(r.respondent_org) }}</td>
                                <td class="px-4 py-4 text-sm text-slate-600">{{ r.respondent_exp || '-' }}</td>
                                <td class="px-4 py-4 text-sm text-slate-600">{{ r.device_type || '-' }}</td>
                                <td class="px-4 py-4">
                                    <span :class="[
                                        'px-2 py-1 rounded-full text-xs font-medium',
                                        r.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'
                                    ]">
                                        {{ r.status === 'completed' ? 'å·²å®Œæˆ' : 'å¡«ç­”ä¸­' }}
                                    </span>
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-500">{{ formatDate(r.updated_at) }}</td>
                                <td class="px-4 py-4">
                                    <div class="flex gap-2">
                                        <button @click="viewDetail(r.survey_id)"
                                            class="px-3 py-1 bg-sky-100 text-sky-700 rounded text-sm hover:bg-sky-200 transition">
                                            æŸ¥çœ‹
                                        </button>
                                        <button @click="deleteResponse(r.survey_id)"
                                            class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200 transition">
                                            åˆªé™¤
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è©³ç´°è³‡æ–™ Modal -->
        <div v-if="showDetail" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between">
                    <h3 class="font-bold text-slate-800">å¡«ç­”è©³ç´°è³‡æ–™</h3>
                    <button @click="showDetail = false" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <div v-if="detailData">
                        <!-- åŸºæœ¬è³‡æ–™ -->
                        <div class="mb-6">
                            <h4 class="font-bold text-slate-700 mb-3">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                                <div><span class="text-slate-500">å§“åï¼š</span>{{ detailData.respondent_name }}</div>
                                <div><span class="text-slate-500">å–®ä½ï¼š</span>{{ formatOrg(detailData.respondent_org) }}</div>
                                <div><span class="text-slate-500">å¹´è³‡ï¼š</span>{{ detailData.respondent_exp }}</div>
                                <div><span class="text-slate-500">å¹´é½¡ï¼š</span>{{ detailData.respondent_age || 'æœªæä¾›' }}</div>
                                <div><span class="text-slate-500">æ€§åˆ¥ï¼š</span>{{ detailData.respondent_gender || 'æœªæä¾›' }}</div>
                                <div><span class="text-slate-500">è£ç½®ï¼š</span>{{ detailData.device_type }}</div>
                                <div><span class="text-slate-500">é–‹å§‹ï¼š</span>{{ formatDate(detailData.start_time) }}</div>
                                <div><span class="text-slate-500">å®Œæˆï¼š</span>{{ formatDate(detailData.end_time) }}</div>
                                <div><span class="text-slate-500">ç‹€æ…‹ï¼š</span>
                                    <span :class="detailData.status === 'completed' ? 'text-green-600' : 'text-amber-600'">
                                        {{ detailData.status === 'completed' ? 'å·²å®Œæˆ' : 'å¡«ç­”ä¸­' }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- DEMATEL å®Œæ•´çŸ©é™£ -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-slate-700">ğŸ“Š DEMATEL å½±éŸ¿é—œä¿‚çŸ©é™£</h4>
                                <div class="flex gap-2">
                                    <button @click="showDematelMatrix = !showDematelMatrix"
                                        class="px-3 py-1 text-sm text-slate-600 hover:bg-slate-100 rounded transition">
                                        {{ showDematelMatrix ? 'æ”¶èµ·' : 'å±•é–‹' }}
                                    </button>
                                    <button @click="downloadSingleDematel"
                                        class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition">
                                        ä¸‹è¼‰ CSV
                                    </button>
                                </div>
                            </div>
                            <div v-if="showDematelMatrix" class="bg-slate-50 rounded-lg p-4 overflow-x-auto">
                                <p class="text-sm text-slate-600 mb-3">å·²è¨˜éŒ„ {{ countDematel }} ç­†å½±éŸ¿é—œä¿‚ (0=ç„¡å½±éŸ¿, 1=ä½, 2=ä¸­, 3=é«˜, 4=éå¸¸é«˜)</p>
                                <table class="text-xs border-collapse w-full min-w-max">
                                    <thead>
                                        <tr>
                                            <th class="border border-slate-300 bg-slate-200 px-2 py-1">From \ To</th>
                                            <th v-for="c in criteriaList" :key="c" class="border border-slate-300 bg-slate-200 px-2 py-1">{{ c }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="from in criteriaList" :key="from">
                                            <td class="border border-slate-300 bg-slate-200 px-2 py-1 font-medium">{{ from }}</td>
                                            <td v-for="to in criteriaList" :key="to"
                                                :class="['border border-slate-300 px-2 py-1 text-center',
                                                    from === to ? 'bg-slate-200' : getDematelCellClass(detailData.dematel_data, from, to)]">
                                                {{ from === to ? '-' : getDematelValue(detailData.dematel_data, from, to) }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-else class="bg-slate-50 rounded-lg p-4 text-sm text-slate-600">
                                å·²è¨˜éŒ„ {{ countDematel }} ç­†å½±éŸ¿é—œä¿‚
                            </div>
                        </div>

                        <!-- ANP æ§‹é¢æ¯”è¼ƒ -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-slate-700">ğŸ“Š ANP æ§‹é¢æ¯”è¼ƒ</h4>
                                <div class="flex gap-2">
                                    <button @click="showAnpDimData = !showAnpDimData"
                                        class="px-3 py-1 text-sm text-slate-600 hover:bg-slate-100 rounded transition">
                                        {{ showAnpDimData ? 'æ”¶èµ·' : 'å±•é–‹' }}
                                    </button>
                                    <button @click="downloadSingleANP"
                                        class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 transition">
                                        ä¸‹è¼‰ CSV
                                    </button>
                                </div>
                            </div>
                            <div v-if="showAnpDimData" class="bg-slate-50 rounded-lg p-4">
                                <p class="text-sm text-slate-600 mb-3">æ§‹é¢é‡è¦æ€§æ¯”è¼ƒ (1=å·¦å´æ¥µé‡è¦, 5=ç›¸ç­‰, 9=å³å´æ¥µé‡è¦)</p>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm">
                                    <div v-for="(pair, i) in dimPairLabels" :key="i"
                                        class="bg-white rounded-lg p-3 border border-slate-200">
                                        <div class="text-slate-500 text-xs mb-1">{{ pair }}</div>
                                        <div class="font-bold text-lg" :class="getAnpDimColor(detailData.anp_dim_data?.[i])">
                                            {{ detailData.anp_dim_data?.[i] ?? '-' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="bg-slate-50 rounded-lg p-4 text-sm text-slate-600">
                                å·²è¨˜éŒ„ 6 ç­†æ§‹é¢æ¯”è¼ƒ
                            </div>
                        </div>

                        <!-- ANP æŒ‡æ¨™æ¯”è¼ƒ -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-slate-700">ğŸ“Š ANP æŒ‡æ¨™æ¯”è¼ƒ</h4>
                                <button @click="showAnpCriteriaData = !showAnpCriteriaData"
                                    class="px-3 py-1 text-sm text-slate-600 hover:bg-slate-100 rounded transition">
                                    {{ showAnpCriteriaData ? 'æ”¶èµ·' : 'å±•é–‹' }}
                                </button>
                            </div>
                            <div v-if="showAnpCriteriaData" class="bg-slate-50 rounded-lg p-4">
                                <p class="text-sm text-slate-600 mb-3">å„æ§‹é¢å½±éŸ¿ä¸‹çš„æŒ‡æ¨™æ¯”è¼ƒ (1=å·¦å´æ¥µé‡è¦, 5=ç›¸ç­‰, 9=å³å´æ¥µé‡è¦)</p>
                                <div class="space-y-4">
                                    <div v-for="(context, key) in detailData.anp_criteria_data" :key="key"
                                        class="bg-white rounded-lg p-3 border border-slate-200">
                                        <div class="text-slate-700 font-medium mb-2">{{ formatAnpContext(key) }}</div>
                                        <div class="grid grid-cols-3 gap-2 text-sm">
                                            <div v-for="(pair, i) in getCriteriaPairs(key)" :key="i"
                                                class="text-center">
                                                <div class="text-xs text-slate-500">{{ pair }}</div>
                                                <div class="font-bold" :class="getAnpDimColor(context[i])">
                                                    {{ context[i] ?? '-' }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="bg-slate-50 rounded-lg p-4 text-sm text-slate-600">
                                å·²è¨˜éŒ„ {{ countAnpCriteria }} ç­†æŒ‡æ¨™æ¯”è¼ƒ
                            </div>
                        </div>

                        <!-- å®Œæ•´ JSON -->
                        <div>
                            <h4 class="font-bold text-slate-700 mb-3">ğŸ“„ å®Œæ•´åŸå§‹è³‡æ–™</h4>
                            <button @click="downloadSingleJSON"
                                class="px-4 py-2 bg-sky-600 text-white rounded-lg text-sm hover:bg-sky-700 transition">
                                ä¸‹è¼‰æ­¤äººå®Œæ•´ JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const authenticated = ref(false);
            const stats = ref({ total: 0, completed: 0, inProgress: 0 });
            const responses = ref([]);
            const showDetail = ref(false);
            const detailData = ref(null);
            const analytics = ref({});

            // æœç´¢å’Œç¯©é¸
            const searchText = ref('');
            const filterOrg = ref('');
            const filterStatus = ref('');

            // æ‰¹é‡é¸æ“‡
            const selectedIds = ref([]);

            // å°å‡ºé¸é …
            const includeIncomplete = ref(false);

            // è©³æƒ…å±•é–‹ç‹€æ…‹
            const showDematelMatrix = ref(false);
            const showAnpDimData = ref(false);
            const showAnpCriteriaData = ref(false);

            // å¸¸é‡
            const criteriaList = ['A1', 'A2', 'A3', 'B1', 'B2', 'B3', 'C1', 'C2', 'C3', 'D1', 'D2', 'D3'];
            const dimPairLabels = ['A vs B', 'A vs C', 'A vs D', 'B vs C', 'B vs D', 'C vs D'];

            // Chart instances
            let dailyChart, deviceChart, timeChart, orgChart;

            // æª¢æŸ¥èªè­‰
            const checkAuth = () => {
                const token = localStorage.getItem('admin_token');
                if (!token || token !== '1102') {
                    window.location.href = '/admin/login';
                    return false;
                }
                authenticated.value = true;
                return true;
            };

            // ç™»å‡º
            const logout = () => {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
            };

            // å–å¾—èªè­‰æ¨™é ­
            const getAuthHeaders = () => {
                const token = localStorage.getItem('admin_token');
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            };

            const fetchStats = async () => {
                try {
                    const res = await fetch('/api/admin/stats', {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) stats.value = data.data;
                } catch (e) { console.error(e); }
            };

            const fetchResponses = async () => {
                try {
                    const res = await fetch('/api/admin/responses', {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) responses.value = data.data;
                } catch (e) { console.error(e); }
            };

            const fetchAnalytics = async () => {
                try {
                    const res = await fetch('/api/admin/analytics', {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) {
                        analytics.value = data.data;
                        updateCharts();
                    }
                } catch (e) { console.error(e); }
            };

            const refreshData = () => {
                fetchStats();
                fetchResponses();
                fetchAnalytics();
            };

            // ç¯©é¸å¾Œçš„éŸ¿æ‡‰åˆ—è¡¨
            const filteredResponses = computed(() => {
                return responses.value.filter(r => {
                    const matchName = !searchText.value ||
                        (r.respondent_name || '').toLowerCase().includes(searchText.value.toLowerCase());
                    const matchOrg = !filterOrg.value || r.respondent_org === filterOrg.value;
                    const matchStatus = !filterStatus.value || r.status === filterStatus.value;
                    return matchName && matchOrg && matchStatus;
                });
            });

            // æ¸…é™¤ç¯©é¸
            const clearFilters = () => {
                searchText.value = '';
                filterOrg.value = '';
                filterStatus.value = '';
            };

            // å…¨é¸ç‹€æ…‹
            const isAllSelected = computed(() => {
                return filteredResponses.value.length > 0 &&
                    filteredResponses.value.every(r => selectedIds.value.includes(r.survey_id));
            });

            // åˆ‡æ›å…¨é¸
            const toggleSelectAll = () => {
                if (isAllSelected.value) {
                    selectedIds.value = [];
                } else {
                    selectedIds.value = filteredResponses.value.map(r => r.survey_id);
                }
            };

            // åˆ‡æ›å–®å€‹é¸æ“‡
            const toggleSelect = (surveyId) => {
                const index = selectedIds.value.indexOf(surveyId);
                if (index > -1) {
                    selectedIds.value.splice(index, 1);
                } else {
                    selectedIds.value.push(surveyId);
                }
            };

            // æ¸…é™¤é¸æ“‡
            const clearSelection = () => {
                selectedIds.value = [];
            };

            // æ‰¹é‡åŒ¯å‡º
            const batchExport = async () => {
                if (selectedIds.value.length === 0) return;

                try {
                    const allData = [];
                    for (const id of selectedIds.value) {
                        const res = await fetch(`/api/admin/response/${id}`, {
                            headers: getAuthHeaders()
                        });
                        const data = await res.json();
                        if (data.success) {
                            allData.push({
                                surveyId: data.data.survey_id,
                                respondent: {
                                    name: data.data.respondent_name,
                                    organization: data.data.respondent_org,
                                    experience: data.data.respondent_exp,
                                    age: data.data.respondent_age,
                                    gender: data.data.respondent_gender
                                },
                                deviceType: data.data.device_type,
                                status: data.data.status,
                                startTime: data.data.start_time,
                                endTime: data.data.end_time,
                                dematel: data.data.dematel_data,
                                anpDimension: data.data.anp_dim_data,
                                anpCriteria: data.data.anp_criteria_data
                            });
                        }
                    }
                    downloadFile(JSON.stringify(allData, null, 2), `selected_${selectedIds.value.length}_responses.json`);
                } catch (e) {
                    console.error(e);
                    alert('åŒ¯å‡ºå¤±æ•—');
                }
            };

            // æ‰¹é‡åˆªé™¤
            const batchDelete = async () => {
                if (selectedIds.value.length === 0) return;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${selectedIds.value.length} ä»½å•å·å—ï¼Ÿ`)) return;

                try {
                    for (const id of selectedIds.value) {
                        await fetch(`/api/admin/response/${id}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                    }
                    selectedIds.value = [];
                    refreshData();
                } catch (e) {
                    console.error(e);
                    alert('åˆªé™¤å¤±æ•—');
                }
            };

            const downloadExport = async (type) => {
                try {
                    const includeAll = includeIncomplete.value ? '?includeAll=true' : '';
                    const res = await fetch(`/api/admin/export/${type}${includeAll}`, {
                        headers: getAuthHeaders()
                    });

                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const suffix = includeIncomplete.value ? '_all' : '_completed';
                        a.download = `fuzzy_danp_${type}${suffix}_${new Date().toISOString().slice(0,10)}.${type.includes('csv') ? 'csv' : 'json'}`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                } catch (e) {
                    console.error(e);
                    alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            };

            // DEMATEL çŸ©é™£è¼”åŠ©å‡½æ•¸
            const getDematelValue = (dematel, from, to) => {
                if (!dematel || !dematel[from]) return '-';
                return dematel[from][to] ?? '-';
            };

            const getDematelCellClass = (dematel, from, to) => {
                const val = getDematelValue(dematel, from, to);
                if (val === '-' || val === undefined) return 'bg-slate-100';
                const colors = ['bg-green-100', 'bg-green-200', 'bg-yellow-200', 'bg-orange-200', 'bg-red-200'];
                return colors[val] || 'bg-slate-100';
            };

            // ANP é¡è‰²è¼”åŠ©å‡½æ•¸
            const getAnpDimColor = (val) => {
                if (val === undefined || val === null) return 'text-slate-400';
                if (val < 5) return 'text-sky-600';
                if (val > 5) return 'text-purple-600';
                return 'text-slate-700';
            };

            // ANP ä¸Šä¸‹æ–‡æ ¼å¼åŒ–
            const formatAnpContext = (key) => {
                const [influence, target] = key.split('_');
                const dimNames = { A: 'å£“åŠ›/å‹•æ©Ÿ', B: 'æ©Ÿæœƒ', C: 'æ…‹åº¦/åˆç†åŒ–', D: 'æ–‡å­—ä¿¡è™Ÿ' };
                return `åœ¨ã€Œ${dimNames[influence]}ã€æ§‹é¢å½±éŸ¿ä¸‹ï¼Œæ¯”è¼ƒã€Œ${dimNames[target]}ã€æ§‹é¢çš„æŒ‡æ¨™`;
            };

            // å–å¾—æŒ‡æ¨™æ¯”è¼ƒå°
            const getCriteriaPairs = (key) => {
                const targetDim = key.split('_')[1];
                const criteriaMap = { A: ['A1', 'A2', 'A3'], B: ['B1', 'B2', 'B3'], C: ['C1', 'C2', 'C3'], D: ['D1', 'D2', 'D3'] };
                const cs = criteriaMap[targetDim];
                return [`${cs[0]} vs ${cs[1]}`, `${cs[0]} vs ${cs[2]}`, `${cs[1]} vs ${cs[2]}`];
            };

            // ANP æŒ‡æ¨™æ¯”è¼ƒè¨ˆæ•¸
            const countAnpCriteria = computed(() => {
                if (!detailData.value?.anp_criteria_data) return 0;
                let count = 0;
                Object.values(detailData.value.anp_criteria_data).forEach(arr => {
                    if (Array.isArray(arr)) count += arr.length;
                });
                return count;
            });

            const formatOrg = (org) => {
                const map = {
                    'big4': 'å››å¤§æœƒè¨ˆå¸«äº‹å‹™æ‰€',
                    'other_cpa': 'å…¶ä»–æœƒè¨ˆå¸«äº‹å‹™æ‰€',
                    'listed_company': 'ä¸Šå¸‚æ«ƒå…¬å¸',
                    'regulator': 'ä¸»ç®¡æ©Ÿé—œ',
                    'academia': 'å­¸è¡“å–®ä½',
                    'other': 'å…¶ä»–'
                };
                return map[org] || org || '-';
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return d.toLocaleString('zh-TW');
            };

            const viewDetail = async (surveyId) => {
                try {
                    const res = await fetch(`/api/admin/response/${surveyId}`, {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) {
                        detailData.value = data.data;
                        showDetail.value = true;
                    }
                } catch (e) { console.error(e); }
            };

            const deleteResponse = async (surveyId) => {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä»½å•å·å—ï¼Ÿ')) return;
                try {
                    await fetch(`/api/admin/response/${surveyId}`, { 
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    refreshData();
                } catch (e) { console.error(e); }
            };

            // åœ–è¡¨æ›´æ–°å‡½æ•¸
            const updateCharts = () => {
                const data = analytics.value;
                if (!data) return;

                // æ¯æ—¥è¶¨å‹¢åœ–
                const dailyLabels = data.dailyStats?.slice(-7).reverse().map(d => d.date) || [];
                const dailyData = data.dailyStats?.slice(-7).reverse().map(d => d.count) || [];
                
                if (dailyChart) dailyChart.destroy();
                const dailyCtx = document.getElementById('dailyChart');
                if (dailyCtx) {
                    dailyChart = new Chart(dailyCtx, {
                        type: 'line',
                        data: {
                            labels: dailyLabels,
                            datasets: [{
                                label: 'æ¯æ—¥å¡«å¯«æ•¸',
                                data: dailyData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // è¨­å‚™é¡å‹åœ“é¤…åœ–
                const deviceLabels = data.deviceStats?.map(d => d.device_type || 'æœªçŸ¥') || [];
                const deviceData = data.deviceStats?.map(d => d.count) || [];
                
                if (deviceChart) deviceChart.destroy();
                const deviceCtx = document.getElementById('deviceChart');
                if (deviceCtx) {
                    deviceChart = new Chart(deviceCtx, {
                        type: 'doughnut',
                        data: {
                            labels: deviceLabels,
                            datasets: [{
                                data: deviceData,
                                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }

                // å¡«å¯«æ™‚é–“åˆ†å¸ƒç›´æ–¹åœ–
                const timeData = data.timeAnalysis || [];
                const timeBins = [0, 10, 20, 30, 60, 120, 999];
                const timeLabels = ['<10åˆ†', '10-20åˆ†', '20-30åˆ†', '30-60åˆ†', '1-2å°æ™‚', '>2å°æ™‚'];
                const timeCounts = timeBins.slice(0, -1).map((min, i) => {
                    const max = timeBins[i + 1];
                    return timeData.filter(t => t.duration_minutes >= min && t.duration_minutes < max).length;
                });

                if (timeChart) timeChart.destroy();
                const timeCtx = document.getElementById('timeChart');
                if (timeCtx) {
                    timeChart = new Chart(timeCtx, {
                        type: 'bar',
                        data: {
                            labels: timeLabels,
                            datasets: [{
                                label: 'å¡«å¯«äººæ•¸',
                                data: timeCounts,
                                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                                borderColor: 'rgb(139, 92, 246)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // æ©Ÿæ§‹åˆ†å¸ƒæ©«æ¢åœ–
                const orgLabels = data.orgStats?.slice(0, 8).map(d => formatOrg(d.respondent_org)) || [];
                const orgData = data.orgStats?.slice(0, 8).map(d => d.count) || [];

                if (orgChart) orgChart.destroy();
                const orgCtx = document.getElementById('orgChart');
                if (orgCtx) {
                    orgChart = new Chart(orgCtx, {
                        type: 'bar',
                        data: {
                            labels: orgLabels,
                            datasets: [{
                                label: 'å¡«å¯«äººæ•¸',
                                data: orgData,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgb(16, 185, 129)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            indexAxis: 'y',
                            scales: {
                                x: { beginAtZero: true }
                            }
                        }
                    });
                }
            };

            const countDematel = computed(() => {
                if (!detailData.value?.dematel_data) return 0;
                let count = 0;
                Object.values(detailData.value.dematel_data).forEach(obj => {
                    count += Object.keys(obj).length;
                });
                return count;
            });

            const downloadSingleDematel = () => {
                const d = detailData.value;
                const dematel = d.dematel_data;
                const criteria = ['A1','A2','A3','B1','B2','B3','C1','C2','C3','D1','D2','D3'];
                
                let csv = 'From,To,Value\n';
                criteria.forEach(from => {
                    criteria.forEach(to => {
                        if (from !== to && dematel[from] && dematel[from][to] !== undefined) {
                            csv += `${from},${to},${dematel[from][to]}\n`;
                        }
                    });
                });
                
                downloadFile(csv, `dematel_${d.survey_id}.csv`);
            };

            const downloadSingleANP = () => {
                const d = detailData.value;
                let csv = 'Type,Context,Left,Right,Value\n';
                
                const dimPairs = [['A','B'],['A','C'],['A','D'],['B','C'],['B','D'],['C','D']];
                dimPairs.forEach((pair, i) => {
                    csv += `Dimension,-,${pair[0]},${pair[1]},${d.anp_dim_data[i] || 5}\n`;
                });
                
                Object.entries(d.anp_criteria_data).forEach(([context, values]) => {
                    const targetDim = context.split('_')[1];
                    const criteriaMap = { A: ['A1','A2','A3'], B: ['B1','B2','B3'], C: ['C1','C2','C3'], D: ['D1','D2','D3'] };
                    const cs = criteriaMap[targetDim];
                    const pairs = [[cs[0],cs[1]], [cs[0],cs[2]], [cs[1],cs[2]]];
                    pairs.forEach((pair, i) => {
                        csv += `Criteria,${context},${pair[0]},${pair[1]},${values[i] || 5}\n`;
                    });
                });
                
                downloadFile(csv, `anp_${d.survey_id}.csv`);
            };

            const downloadSingleJSON = () => {
                const d = detailData.value;
                downloadFile(JSON.stringify(d.raw_json, null, 2), `full_${d.survey_id}.json`);
            };

            const downloadFile = (content, filename) => {
                const blob = new Blob(['\uFEFF' + content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            };

            onMounted(() => {
                if (checkAuth()) {
                    refreshData();
                    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
                    setInterval(refreshData, 30000);
                }
            });

            return {
                authenticated, analytics, stats, responses, showDetail, detailData,
                refreshData, formatOrg, formatDate, viewDetail, deleteResponse,
                countDematel, downloadSingleDematel, downloadSingleANP, downloadSingleJSON,
                logout, downloadExport,
                // æœç´¢å’Œç¯©é¸
                searchText, filterOrg, filterStatus, filteredResponses, clearFilters,
                // æ‰¹é‡æ“ä½œ
                selectedIds, isAllSelected, toggleSelectAll, toggleSelect, clearSelection,
                batchExport, batchDelete,
                // å°å‡ºé¸é …
                includeIncomplete,
                // è©³æƒ…å±•é–‹
                showDematelMatrix, showAnpDimData, showAnpCriteriaData,
                // å¸¸é‡å’Œè¼”åŠ©å‡½æ•¸
                criteriaList, dimPairLabels, getDematelValue, getDematelCellClass,
                getAnpDimColor, formatAnpContext, getCriteriaPairs, countAnpCriteria
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
