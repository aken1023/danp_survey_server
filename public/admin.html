<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy DANP å•å·ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="app">
        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-sky-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold">FD</span>
                        </div>
                        <div>
                            <h1 class="font-bold text-slate-800">Fuzzy DANP å•å·ç®¡ç†å¾Œå°</h1>
                            <p class="text-xs text-slate-500">è²¡å ±èˆå¼Šé¢¨éšªæŒ‡æ¨™å°ˆå®¶å•å·</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="refreshData" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition">
                            ğŸ”„ é‡æ–°æ•´ç†
                        </button>
                        <button @click="logout" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                            ğŸšª ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ç™»å…¥æª¢æŸ¥é®ç½© -->
        <div v-if="!authenticated" class="fixed inset-0 bg-white flex items-center justify-center z-50">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-slate-600">é©—è­‰ç®¡ç†å“¡æ¬Šé™ä¸­...</p>
            </div>
        </div>

        <div v-else class="max-w-7xl mx-auto px-4 py-6">
            <!-- æ“´å±•çµ±è¨ˆå¡ç‰‡ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">ç¸½å¡«ç­”æ•¸</p>
                            <p class="text-3xl font-bold text-slate-800">{{ stats.total }}</p>
                        </div>
                        <div class="w-12 h-12 bg-sky-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">ğŸ“‹</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">å·²å®Œæˆ</p>
                            <p class="text-3xl font-bold text-green-600">{{ stats.completed }}</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">âœ…</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">å¡«ç­”ä¸­</p>
                            <p class="text-3xl font-bold text-amber-600">{{ stats.inProgress }}</p>
                        </div>
                        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">â³</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500">å¹³å‡æ™‚é–“</p>
                            <p class="text-3xl font-bold text-purple-600">{{ analytics.summary?.avgDuration || 0 }}</p>
                            <p class="text-xs text-slate-400">åˆ†é˜</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">â±ï¸</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœ–è¡¨åˆ†æå€ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- æ¯æ—¥å¡«å¯«è¶¨å‹¢ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">ğŸ“ˆ æ¯æ—¥å¡«å¯«è¶¨å‹¢</h3>
                    <canvas id="dailyChart" width="400" height="200"></canvas>
                </div>

                <!-- è¨­å‚™é¡å‹åˆ†å¸ƒ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">ğŸ“± è¨­å‚™é¡å‹åˆ†å¸ƒ</h3>
                    <canvas id="deviceChart" width="400" height="200"></canvas>
                </div>

                <!-- å¡«å¯«æ™‚é–“åˆ†æ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">â° å¡«å¯«æ™‚é–“åˆ†å¸ƒ</h3>
                    <canvas id="timeChart" width="400" height="200"></canvas>
                </div>

                <!-- æ©Ÿæ§‹åˆ†å¸ƒ -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">ğŸ¢ æ©Ÿæ§‹åˆ†å¸ƒ</h3>
                    <canvas id="orgChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- åŒ¯å‡ºæŒ‰éˆ•å€ -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="font-bold text-slate-800 mb-4">ğŸ“¥ åŒ¯å‡ºè³‡æ–™</h2>
                <div class="flex flex-wrap gap-3">
                    <a @click="downloadExport('json')" 
                       class="px-6 py-3 bg-sky-600 text-white rounded-lg font-medium hover:bg-sky-700 transition inline-flex items-center gap-2 cursor-pointer">
                        ğŸ“„ åŒ¯å‡ºå®Œæ•´ JSON
                    </a>
                    <a @click="downloadExport('dematel-csv')" 
                       class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition inline-flex items-center gap-2 cursor-pointer">
                        ğŸ“Š åŒ¯å‡º DEMATEL CSV
                    </a>
                    <a @click="downloadExport('anp-csv')" 
                       class="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition inline-flex items-center gap-2 cursor-pointer">
                        ğŸ“Š åŒ¯å‡º ANP CSV
                    </a>
                </div>
                <p class="text-sm text-slate-500 mt-3">* åƒ…åŒ¯å‡ºå·²å®Œæˆçš„å•å·</p>
            </div>

            <!-- å¡«ç­”åˆ—è¡¨ -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-6 border-b">
                    <h2 class="font-bold text-slate-800">ğŸ“ å¡«ç­”è¨˜éŒ„</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å¡«ç­”è€…</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å–®ä½</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å¹´è³‡</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">è£ç½®</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ›´æ–°æ™‚é–“</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-if="responses.length === 0">
                                <td colspan="7" class="px-4 py-8 text-center text-slate-500">
                                    å°šç„¡å¡«ç­”è¨˜éŒ„
                                </td>
                            </tr>
                            <tr v-for="r in responses" :key="r.survey_id" class="hover:bg-slate-50">
                                <td class="px-4 py-4">
                                    <div class="font-medium text-slate-800">{{ r.respondent_name || '(æœªå¡«)' }}</div>
                                    <div class="text-xs text-slate-400">{{ r.survey_id.slice(0, 8) }}...</div>
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-600">{{ formatOrg(r.respondent_org) }}</td>
                                <td class="px-4 py-4 text-sm text-slate-600">{{ r.respondent_exp || '-' }}</td>
                                <td class="px-4 py-4 text-sm text-slate-600">{{ r.device_type || '-' }}</td>
                                <td class="px-4 py-4">
                                    <span :class="[
                                        'px-2 py-1 rounded-full text-xs font-medium',
                                        r.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'
                                    ]">
                                        {{ r.status === 'completed' ? 'å·²å®Œæˆ' : 'å¡«ç­”ä¸­' }}
                                    </span>
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-500">{{ formatDate(r.updated_at) }}</td>
                                <td class="px-4 py-4">
                                    <div class="flex gap-2">
                                        <button @click="viewDetail(r.survey_id)" 
                                            class="px-3 py-1 bg-sky-100 text-sky-700 rounded text-sm hover:bg-sky-200 transition">
                                            æŸ¥çœ‹
                                        </button>
                                        <button @click="deleteResponse(r.survey_id)" 
                                            class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200 transition">
                                            åˆªé™¤
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è©³ç´°è³‡æ–™ Modal -->
        <div v-if="showDetail" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between">
                    <h3 class="font-bold text-slate-800">å¡«ç­”è©³ç´°è³‡æ–™</h3>
                    <button @click="showDetail = false" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <div v-if="detailData">
                        <!-- åŸºæœ¬è³‡æ–™ -->
                        <div class="mb-6">
                            <h4 class="font-bold text-slate-700 mb-3">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                                <div><span class="text-slate-500">å§“åï¼š</span>{{ detailData.respondent_name }}</div>
                                <div><span class="text-slate-500">å–®ä½ï¼š</span>{{ formatOrg(detailData.respondent_org) }}</div>
                                <div><span class="text-slate-500">å¹´è³‡ï¼š</span>{{ detailData.respondent_exp }}</div>
                                <div><span class="text-slate-500">å¹´é½¡ï¼š</span>{{ detailData.respondent_age || 'æœªæä¾›' }}</div>
                                <div><span class="text-slate-500">æ€§åˆ¥ï¼š</span>{{ detailData.respondent_gender || 'æœªæä¾›' }}</div>
                                <div><span class="text-slate-500">è£ç½®ï¼š</span>{{ detailData.device_type }}</div>
                            </div>
                        </div>

                        <!-- DEMATEL æ‘˜è¦ -->
                        <div class="mb-6">
                            <h4 class="font-bold text-slate-700 mb-3">ğŸ“Š DEMATEL è³‡æ–™</h4>
                            <div class="bg-slate-50 rounded-lg p-4 text-sm">
                                <p class="text-slate-600 mb-2">å½±éŸ¿é—œä¿‚çŸ©é™£å·²è¨˜éŒ„ {{ countDematel }} ç­†</p>
                                <button @click="downloadSingleDematel" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition">
                                    ä¸‹è¼‰æ­¤äºº DEMATEL CSV
                                </button>
                            </div>
                        </div>

                        <!-- ANP æ‘˜è¦ -->
                        <div class="mb-6">
                            <h4 class="font-bold text-slate-700 mb-3">ğŸ“Š ANP è³‡æ–™</h4>
                            <div class="bg-slate-50 rounded-lg p-4 text-sm">
                                <p class="text-slate-600 mb-2">æ§‹é¢æ¯”è¼ƒï¼š6 ç­† | æŒ‡æ¨™æ¯”è¼ƒï¼š48 ç­†</p>
                                <button @click="downloadSingleANP" 
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition">
                                    ä¸‹è¼‰æ­¤äºº ANP CSV
                                </button>
                            </div>
                        </div>

                        <!-- å®Œæ•´ JSON -->
                        <div>
                            <h4 class="font-bold text-slate-700 mb-3">ğŸ“„ å®Œæ•´åŸå§‹è³‡æ–™</h4>
                            <button @click="downloadSingleJSON" 
                                class="px-4 py-2 bg-sky-600 text-white rounded-lg text-sm hover:bg-sky-700 transition">
                                ä¸‹è¼‰æ­¤äººå®Œæ•´ JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const authenticated = ref(false);
            const stats = ref({ total: 0, completed: 0, inProgress: 0 });
            const responses = ref([]);
            const showDetail = ref(false);
            const detailData = ref(null);
            const analytics = ref({});
            
            // Chart instances
            let dailyChart, deviceChart, timeChart, orgChart;

            // æª¢æŸ¥èªè­‰
            const checkAuth = () => {
                const token = localStorage.getItem('admin_token');
                if (!token || token !== '1102') {
                    window.location.href = '/admin/login';
                    return false;
                }
                authenticated.value = true;
                return true;
            };

            // ç™»å‡º
            const logout = () => {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
            };

            // å–å¾—èªè­‰æ¨™é ­
            const getAuthHeaders = () => {
                const token = localStorage.getItem('admin_token');
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            };

            const fetchStats = async () => {
                try {
                    const res = await fetch('/api/admin/stats', {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) stats.value = data.data;
                } catch (e) { console.error(e); }
            };

            const fetchResponses = async () => {
                try {
                    const res = await fetch('/api/admin/responses', {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) responses.value = data.data;
                } catch (e) { console.error(e); }
            };

            const fetchAnalytics = async () => {
                try {
                    const res = await fetch('/api/admin/analytics', {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) {
                        analytics.value = data.data;
                        updateCharts();
                    }
                } catch (e) { console.error(e); }
            };

            const refreshData = () => {
                fetchStats();
                fetchResponses();
                fetchAnalytics();
            };

            const downloadExport = async (type) => {
                try {
                    const res = await fetch(`/api/admin/export/${type}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `fuzzy_danp_${type}_${new Date().toISOString().slice(0,10)}.${type.includes('csv') ? 'csv' : 'json'}`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                } catch (e) { 
                    console.error(e); 
                    alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            };

            const formatOrg = (org) => {
                const map = {
                    'big4': 'å››å¤§æœƒè¨ˆå¸«äº‹å‹™æ‰€',
                    'other_cpa': 'å…¶ä»–æœƒè¨ˆå¸«äº‹å‹™æ‰€',
                    'listed_company': 'ä¸Šå¸‚æ«ƒå…¬å¸',
                    'regulator': 'ä¸»ç®¡æ©Ÿé—œ',
                    'academia': 'å­¸è¡“å–®ä½',
                    'other': 'å…¶ä»–'
                };
                return map[org] || org || '-';
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return d.toLocaleString('zh-TW');
            };

            const viewDetail = async (surveyId) => {
                try {
                    const res = await fetch(`/api/admin/response/${surveyId}`, {
                        headers: getAuthHeaders()
                    });
                    const data = await res.json();
                    if (data.success) {
                        detailData.value = data.data;
                        showDetail.value = true;
                    }
                } catch (e) { console.error(e); }
            };

            const deleteResponse = async (surveyId) => {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä»½å•å·å—ï¼Ÿ')) return;
                try {
                    await fetch(`/api/admin/response/${surveyId}`, { 
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    refreshData();
                } catch (e) { console.error(e); }
            };

            // åœ–è¡¨æ›´æ–°å‡½æ•¸
            const updateCharts = () => {
                const data = analytics.value;
                if (!data) return;

                // æ¯æ—¥è¶¨å‹¢åœ–
                const dailyLabels = data.dailyStats?.slice(-7).reverse().map(d => d.date) || [];
                const dailyData = data.dailyStats?.slice(-7).reverse().map(d => d.count) || [];
                
                if (dailyChart) dailyChart.destroy();
                const dailyCtx = document.getElementById('dailyChart');
                if (dailyCtx) {
                    dailyChart = new Chart(dailyCtx, {
                        type: 'line',
                        data: {
                            labels: dailyLabels,
                            datasets: [{
                                label: 'æ¯æ—¥å¡«å¯«æ•¸',
                                data: dailyData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // è¨­å‚™é¡å‹åœ“é¤…åœ–
                const deviceLabels = data.deviceStats?.map(d => d.device_type || 'æœªçŸ¥') || [];
                const deviceData = data.deviceStats?.map(d => d.count) || [];
                
                if (deviceChart) deviceChart.destroy();
                const deviceCtx = document.getElementById('deviceChart');
                if (deviceCtx) {
                    deviceChart = new Chart(deviceCtx, {
                        type: 'doughnut',
                        data: {
                            labels: deviceLabels,
                            datasets: [{
                                data: deviceData,
                                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }

                // å¡«å¯«æ™‚é–“åˆ†å¸ƒç›´æ–¹åœ–
                const timeData = data.timeAnalysis || [];
                const timeBins = [0, 10, 20, 30, 60, 120, 999];
                const timeLabels = ['<10åˆ†', '10-20åˆ†', '20-30åˆ†', '30-60åˆ†', '1-2å°æ™‚', '>2å°æ™‚'];
                const timeCounts = timeBins.slice(0, -1).map((min, i) => {
                    const max = timeBins[i + 1];
                    return timeData.filter(t => t.duration_minutes >= min && t.duration_minutes < max).length;
                });

                if (timeChart) timeChart.destroy();
                const timeCtx = document.getElementById('timeChart');
                if (timeCtx) {
                    timeChart = new Chart(timeCtx, {
                        type: 'bar',
                        data: {
                            labels: timeLabels,
                            datasets: [{
                                label: 'å¡«å¯«äººæ•¸',
                                data: timeCounts,
                                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                                borderColor: 'rgb(139, 92, 246)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // æ©Ÿæ§‹åˆ†å¸ƒæ©«æ¢åœ–
                const orgLabels = data.orgStats?.slice(0, 8).map(d => formatOrg(d.respondent_org)) || [];
                const orgData = data.orgStats?.slice(0, 8).map(d => d.count) || [];

                if (orgChart) orgChart.destroy();
                const orgCtx = document.getElementById('orgChart');
                if (orgCtx) {
                    orgChart = new Chart(orgCtx, {
                        type: 'bar',
                        data: {
                            labels: orgLabels,
                            datasets: [{
                                label: 'å¡«å¯«äººæ•¸',
                                data: orgData,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgb(16, 185, 129)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            indexAxis: 'y',
                            scales: {
                                x: { beginAtZero: true }
                            }
                        }
                    });
                }
            };

            const countDematel = computed(() => {
                if (!detailData.value?.dematel_data) return 0;
                let count = 0;
                Object.values(detailData.value.dematel_data).forEach(obj => {
                    count += Object.keys(obj).length;
                });
                return count;
            });

            const downloadSingleDematel = () => {
                const d = detailData.value;
                const dematel = d.dematel_data;
                const criteria = ['A1','A2','A3','B1','B2','B3','C1','C2','C3','D1','D2','D3'];
                
                let csv = 'From,To,Value\n';
                criteria.forEach(from => {
                    criteria.forEach(to => {
                        if (from !== to && dematel[from] && dematel[from][to] !== undefined) {
                            csv += `${from},${to},${dematel[from][to]}\n`;
                        }
                    });
                });
                
                downloadFile(csv, `dematel_${d.survey_id}.csv`);
            };

            const downloadSingleANP = () => {
                const d = detailData.value;
                let csv = 'Type,Context,Left,Right,Value\n';
                
                const dimPairs = [['A','B'],['A','C'],['A','D'],['B','C'],['B','D'],['C','D']];
                dimPairs.forEach((pair, i) => {
                    csv += `Dimension,-,${pair[0]},${pair[1]},${d.anp_dim_data[i] || 5}\n`;
                });
                
                Object.entries(d.anp_criteria_data).forEach(([context, values]) => {
                    const targetDim = context.split('_')[1];
                    const criteriaMap = { A: ['A1','A2','A3'], B: ['B1','B2','B3'], C: ['C1','C2','C3'], D: ['D1','D2','D3'] };
                    const cs = criteriaMap[targetDim];
                    const pairs = [[cs[0],cs[1]], [cs[0],cs[2]], [cs[1],cs[2]]];
                    pairs.forEach((pair, i) => {
                        csv += `Criteria,${context},${pair[0]},${pair[1]},${values[i] || 5}\n`;
                    });
                });
                
                downloadFile(csv, `anp_${d.survey_id}.csv`);
            };

            const downloadSingleJSON = () => {
                const d = detailData.value;
                downloadFile(JSON.stringify(d.raw_json, null, 2), `full_${d.survey_id}.json`);
            };

            const downloadFile = (content, filename) => {
                const blob = new Blob(['\uFEFF' + content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            };

            onMounted(() => {
                if (checkAuth()) {
                    refreshData();
                    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
                    setInterval(refreshData, 30000);
                }
            });

            return {
                authenticated, analytics, stats, responses, showDetail, detailData,
                refreshData, formatOrg, formatDate, viewDetail, deleteResponse,
                countDematel, downloadSingleDematel, downloadSingleANP, downloadSingleJSON,
                logout, downloadExport
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
